<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CoC Offer Value Calculator</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&family=Titan+One&display=swap" rel="stylesheet">
    
    <style>
        /* --- CLASH OF CLANS THEME VARIABLES --- */
        :root {
            color-scheme: dark;

            --clash-bg: #4a4a4a;
            --clash-panel-bg: #26292e;
            --clash-panel-border: #121212;
            --clash-yellow: #ffe65e;
            --clash-text-stroke: 2px #000;
            --clash-green-top: #96c40e;
            --clash-green-bot: #6b9e03;
            --clash-red-top: #ff5e5e;
            --clash-red-bot: #ce1f1f;
            --clash-blue-top: #4da6ff;
            --clash-blue-bot: #0066cc;
            
            /* Palette */
            --c-green-400: #4ade80;
            --c-yellow-400: #facc15;
            --c-red-400: #f87171;
            --c-purple-400: #c084fc;
            --c-gray-300: #d1d5db;
            --c-gray-400: #9ca3af;
            --c-gray-500: #6b7280;
            --c-gray-200: #e5e7eb;
            --c-gray-800: #1f2937;
        }

        /* --- GLOBAL RESET & LAYOUT --- */
        * { box-sizing: border-box; }

        body {
            font-family: 'Rubik', sans-serif;
            background: radial-gradient(50% 38.93% at 50% 47.22%, rgb(116, 74, 43) 0px, rgb(77, 46, 23) 100%);
            background-attachment: fixed;
            color: #f0f0f0;
            overflow-x: hidden;
            min-height: 100vh;
            overscroll-behavior-y: none;
            margin: 0;
            padding: 0.5rem; 
            padding-bottom: 8rem;
        }

        body::before {
            position: fixed;
            top: 0px;
            left: 0px;
            content: "";
            width: 100%;
            height: 100%;
            background-image: url("img/coc-pattern.png");
            background-repeat: repeat;
            background-size: 260px 260px, 100%;
            opacity: 0.15;
            z-index: -1;
        }

        .app-container {
            max-width: 64rem;
            margin: 0 auto;
        }

        .hidden { display: none !important; }

        @media (min-width: 768px) {
            body { padding: 1.5rem; padding-bottom: 8rem; }
        }

        /* --- SHARED TYPOGRAPHY --- */
        .clash-font {
            font-family: 'Titan One', cursive;
            letter-spacing: 1px;
            color: var(--clash-yellow);
            text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
            margin: 0;
        }
        
        /* --- SECTION HEADERS --- */
        .section-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            margin-left: 0.5rem;
        }

        .section-icon-gem {
            color: var(--c-green-400);
            font-size: 1.25rem;
            filter: drop-shadow(0 4px 3px rgb(0 0 0 / 0.07)) drop-shadow(0 2px 2px rgb(0 0 0 / 0.06));
        }

        .section-icon-scroll {
            color: var(--c-yellow-400);
            font-size: 1.25rem;
            filter: drop-shadow(0 4px 3px rgb(0 0 0 / 0.07)) drop-shadow(0 2px 2px rgb(0 0 0 / 0.06));
        }

        .section-title {
            font-family: 'Titan One', cursive;
            color: var(--clash-yellow);
            margin: 0;
            font-size: 1.8rem;
            font-weight: 500;
            text-transform: uppercase;
            text-shadow: 0 .05em 0 #000,-.015em .07em 0 #000,.015em .07em 0 #000;
            -webkit-text-stroke-width: .045em;
            -webkit-text-stroke-color: #000;
        }

        /* --- GEM PACK SECTION --- */
        .gem-section {
            margin-bottom: 2rem;
        }

        .clash-panel {
            background-image: linear-gradient(180deg,#3d3836,#302b29 20.9%), linear-gradient(180deg,#3d3836,#302b29 20.9%);
            border: 2px solid #000;
            border-radius: 16px;
            box-shadow: inset 0 3px 0 0 hsla(0,0%,100%,.1);
            position: relative;
            padding: 1rem;
            overflow-x: auto;
        }

        .gem-scroll-container {
            display: flex;
            gap: 0.75rem;
            padding-bottom: 0.5rem;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
        }

        .gem-pack-card {
            background: radial-gradient(55.62% 45.62% at 50% 45%,#857654 .5%,#301b14 68.75%,#1d1816 97.12%);
            min-width: 100px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
            position: relative;
            scroll-snap-align: center;
        }
        
        .gem-pack-card::before {
            content: "";
            position: absolute;
            inset: 0 0;
            padding: 2px;
            z-index: 1;
            background: linear-gradient(rgba(222,185,126,.3),rgba(0,0,0,.1));
            -webkit-mask: linear-gradient(white 0 0) content-box,linear-gradient(white 0 0);
            mask: linear-gradient(white 0 0) content-box,linear-gradient(white 0 0);
              mask-composite: add, add;
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            border-radius: inherit;
            pointer-events: none;
        }

        .gem-amount-text {
            color: var(--c-green-400);
            font-weight: 900;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            filter: drop-shadow(0 4px 3px rgb(0 0 0 / 0.07)) drop-shadow(0 2px 2px rgb(0 0 0 / 0.06));
        }

        .gem-image {
            object-fit: contain;
            margin-bottom: 0.5rem;
            filter: drop-shadow(0 10px 8px rgb(0 0 0 / 0.04)) drop-shadow(0 4px 3px rgb(0 0 0 / 0.1));
            max-width: 100%;
        }

        .gem-input-wrapper {
            width: 100%;
            position: relative;
            background: #1a1b1e;
            box-shadow: inset 0 2px 0 0 hsla(0,0%,100%,.1);
            border-radius: 0.25rem;
            padding: 0.25rem;
        }

        .gem-price-input {
            background: none;
            border-radius: 6px;
            color: #fff;
            text-align: center;
            width: 100%;
            font-weight: bold;
            padding: 4px;
            font-family: 'Rubik', sans-serif;
            border: 1px solid transparent;
            font-size: 1rem;
        }
        .gem-price-input:focus { outline: none; border-color: #4da6ff; }


        /* --- OFFERS SECTION --- */
        .offers-section {
            /* Handled by elements inside, just a wrapper concept */
        }

        /* Control Bar */
        .control-bar {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-end;
            gap: 1rem;
            margin-bottom: 0.5rem;
            margin-left: 0.5rem;
            margin-right: 0.5rem;
        }
        @media (min-width: 640px) {
            .control-bar {
                flex-direction: row;
                align-items: center;
            }
        }

        .action-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* Compact Mode Toggle */
        .compact-toggle-container {
            display: flex;
            align-items: center;
            margin-right: 0.5rem;
        }

        .compact-label {
            font-size: 0.75rem;
            color: var(--c-gray-400);
            font-weight: 500;
            text-transform: uppercase;
            margin-right: 0.5rem;
        }

        .toggle-wrapper {
            position: relative;
            display: inline-block;
            width: 2.5rem;
            margin-right: 0.5rem;
        }

        .toggle-checkbox {
            position: absolute;
            appearance: none;
            cursor: pointer;
            right: calc(100% - 1.25rem);
            top: 0;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 9999px;
            background-color: white;
            border: 4px solid var(--c-gray-500);
            transition: all 0.2s;
            display: block;
            margin: 0;
        }
        .toggle-checkbox:checked {
            right: 0;
            left: auto;
            border-color: #68D391;
        }
        
        .toggle-track {
            display: block;
            overflow: hidden;
            height: 1.25rem;
            border-radius: 9999px;
            background-color: var(--c-gray-500);
            cursor: pointer;
        }
        .toggle-checkbox:checked + .toggle-track {
            background-color: #68D391;
        }

        /* Action Buttons */
        .btn-share {
            border: none;
            cursor: pointer;
            transition: all 0.1s;
            touch-action: manipulation;
            font-family: 'Titan One', cursive;
            text-shadow: 0 2px 0 rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            background: linear-gradient(to bottom, var(--clash-blue-top), var(--clash-blue-bot));
            border-radius: 8px;
            color: white;
            box-shadow: 0 4px 0 #004080, 0 6px 4px rgba(0,0,0,0.4);
            padding: 0.45rem 0.75rem;
            font-size: 0.75rem;
        }
        .btn-share:hover { filter: brightness(1.1); }
        .btn-share:active { transform: translateY(4px); box-shadow: 0 0 0 #004080, inset 0 2px 4px rgba(0,0,0,0.4); }

        .btn-clear {
            border: none;
            cursor: pointer;
            transition: all 0.1s;
            touch-action: manipulation;
            font-family: 'Titan One', cursive;
            text-shadow: 0 2px 0 rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            background: linear-gradient(to bottom, var(--clash-red-top), var(--clash-red-bot));
            border-radius: 8px;
            color: white;
            box-shadow: 0 4px 0 #800000, 0 6px 4px rgba(0,0,0,0.4);
            padding: 0.45rem 0.75rem;
            font-size: 0.75rem;
        }
        .btn-clear:hover { filter: brightness(1.1); }
        .btn-clear:active { transform: translateY(4px); box-shadow: 0 0 0 #800000, inset 0 2px 4px rgba(0,0,0,0.4); }


        /* --- OFFER ROW COMPONENT --- */
        #offers-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .offer-row {
            background-image: linear-gradient(180deg,#3d3836,#302b29 20.9%), linear-gradient(180deg,#3d3836,#302b29 20.9%);
            border: 2px solid #000;
            border-radius: 12px;
            display: flex;
            align-items: stretch;
            min-height: 145px;
            overflow: hidden;
            box-shadow: inset 0 3px 0 0 hsla(0,0%,100%,.1);
            filter: drop-shadow(0 12px 6px rgba(0,0,0,.7));
            transition: min-height 0.3s ease;
            position: relative;
        }
        
        .offer-row:hover .delete-offer-btn {
            opacity: 1;
        }

        .delete-offer-btn {
            position: absolute;
            top: 0;
            left: 0;
            background-color: rgba(127, 29, 29, 0.9);
            color: white;
            font-size: 10px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.5rem 0.75rem;
            border-bottom-right-radius: 0.25rem;
            z-index: 20;
            transition: opacity 0.15s;
            border: none;
            cursor: pointer;
        }
        
        @media (min-width: 768px) {
            .delete-offer-btn {
                padding: 0.25rem 0.5rem;
                opacity: 0;
            }
        }

        .offer-scroll-area {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
            overflow-x: auto;
            padding: 12px;
            -ms-overflow-style: none;
            scrollbar-width: none; 
            -webkit-overflow-scrolling: touch;
            scroll-snap-type: x mandatory;
        }
        .offer-scroll-area::-webkit-scrollbar { display: none; }

        /* Offer Card (Generic Base) */
        .offer-card {
            min-width: 100px;
            height: 125px;
            background: radial-gradient(55.62% 55.62% at 50% 50%,#857654 .5%,#301b14 68.75%,#1d1816 97.12%);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            position: relative;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
            scroll-snap-align: start;
        }

        .offer-card::before {
            content: "";
            position: absolute;
            inset: 0 0;
            padding: 2px;
            z-index: 1;
            background: linear-gradient(rgba(222,185,126,.3),rgba(0,0,0,.1));
            -webkit-mask: linear-gradient(white 0 0) content-box,linear-gradient(white 0 0);
            mask: linear-gradient(white 0 0) content-box,linear-gradient(white 0 0);
              mask-composite: add, add;
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            border-radius: inherit;
            pointer-events: none;
        }

        /* Price Card Specifics */
        .price-label {
            color: var(--c-yellow-400);
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 10px;
        }

        .price-symbol {
            font-size: 1.875rem;
            line-height: 2.25rem;
            font-weight: 500;
            color: white;
            filter: drop-shadow(0 4px 3px rgb(0 0 0 / 0.07)) drop-shadow(0 2px 2px rgb(0 0 0 / 0.06));
        }

        .price-input-wrapper {
            width: 100%;
            background: #1a1b1e;
            box-shadow: inset 0 2px 0 0 hsla(0,0%,100%,.1);
            border-radius: 0.25rem;
        }

        .price-input {
            background: none;
            border-radius: 6px;
            color: #fff;
            text-align: center;
            width: 100%;
            font-weight: bold;
            padding: 4px;
            font-family: 'Rubik', sans-serif;
            border: 1px solid transparent;
            font-size: 1.125rem;
        }
        .price-input:focus { outline: none; border-color: #4da6ff; }

        /* Item Card Specifics */
        .item-delete-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(to bottom, var(--clash-red-top), var(--clash-red-bot));
            color: white;
            border-radius: 5px;
            width: 24px;
            height: 24px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 4px 0 #800000, 0 6px 4px rgba(0,0,0,0.4);
        }
        .item-delete-btn:hover { filter: brightness(1.1); }
        .item-delete-btn:active { transform: translateY(4px); box-shadow: 0 0 0 #800000, inset 0 2px 4px rgba(0,0,0,0.4); }

        .item-name-text {
            font-size: 10px;
            color: var(--c-gray-400);
            text-align: center;
            line-height: 1.25;
            height: 1.5rem;
            overflow: hidden;
            text-transform: uppercase;
            font-weight: 500;
            letter-spacing: 0.05em;
        }

        .item-card-image {
            width: 2.5rem;
            height: 2.5rem;
            object-fit: contain;
            margin-bottom: 0.25rem;
            filter: drop-shadow(0 10px 8px rgb(0 0 0 / 0.04)) drop-shadow(0 4px 3px rgb(0 0 0 / 0.1));
        }

        .item-qty-wrapper {
            width: 100%;
            background: #1a1b1e;
            box-shadow: inset 0 2px 0 0 hsla(0,0%,100%,.1);
            border-radius: 0.25rem;
            margin-top: 0.25rem;
        }

        .item-qty-input {
            background: none;
            border-radius: 6px;
            color: #fff;
            text-align: center;
            width: 100%;
            font-weight: bold;
            padding: 4px;
            font-family: 'Rubik', sans-serif;
            border: 1px solid transparent;
            font-size: 1rem;
        }
        .item-qty-input:focus { outline: none; border-color: #4da6ff; }

        /* Add Item Button (in row) */
        .add-item-card {
            min-width: 80px;
            height: 120px;
            background: rgba(0,0,0,0.2);
            border: 3px dashed #666;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            scroll-snap-align: start;
        }
        .offer-row:hover .add-item-card { border-color: #aaa; }
        .add-item-card:hover { background: rgba(255, 255, 255, 0.05); border-color: #aaa; transform: scale(1.02); }
        
        .add-item-icon {
            color: var(--c-gray-500);
            font-size: 1.875rem;
            transition: color 0.15s;
        }
        .add-item-card:hover .add-item-icon { color: white; }

        /* Result Area */
        .offer-result-area {
            width: 110px;
            background: linear-gradient(to bottom, #2b3036, #1f2226);
            border-left: 2px solid #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
            text-align: center;
            box-shadow: inset 0 3px 0 0 hsla(0,0%,100%,.1);
            transition: width 0.3s ease;
            z-index: 20;
        }

        .result-label {
            font-size: 0.75rem;
            color: var(--c-gray-400);
            text-transform: uppercase;
            font-weight: 500;
            margin-bottom: 0.25rem;
            letter-spacing: 0.05em;
        }

        .result-multiplier {
            font-size: 1.875rem;
            line-height: 2.25rem;
            font-weight: 900;
            filter: drop-shadow(0 10px 8px rgb(0 0 0 / 0.04)) drop-shadow(0 4px 3px rgb(0 0 0 / 0.1));
        }

        .result-stars {
            font-size: 9px;
            margin-bottom: 0.25rem;
        }

        .result-gems {
            color: var(--c-gray-400);
            font-weight: 500;
            font-size: 10px;
        }

        /* Compact Mode Overrides */
        body.compact-mode .offer-card {
            min-width: 80px;
            height: 70px;
            justify-content: center;
        }
        body.compact-mode .item-card-image { display: none; }
        body.compact-mode .price-symbol { display: none; }
        body.compact-mode .offer-row { min-height: 90px; }
        body.compact-mode .add-item-card { height: 70px; min-width: 60px; }
        body.compact-mode .offer-result-area { width: 90px; }


        /* --- MAIN BUTTONS --- */
        .btn-add-offer {
            border: none;
            cursor: pointer;
            transition: all 0.1s;
            touch-action: manipulation;
            font-family: 'Titan One', cursive;
            text-shadow: 0 2px 0 rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            background: linear-gradient(to bottom, var(--clash-green-top), var(--clash-green-bot));
            border-radius: 8px;
            color: white;
            box-shadow: 0 4px 0 #3a5700, 0 6px 4px rgba(0,0,0,0.4);
            width: 100%;
            height: 4rem;
            margin-top: 1.5rem;
            font-size: 1.25rem;
            gap: 0.5rem;
        }
        .btn-add-offer:hover { filter: brightness(1.1); }
        .btn-add-offer:active { transform: translateY(4px); box-shadow: 0 0 0 #3a5700, inset 0 2px 4px rgba(0,0,0,0.4); }

        .btn-add-icon-wrapper {
            background-color: rgba(0,0,0,0.2);
            border-radius: 9999px;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            border: 1px solid rgba(255,255,255,0.3);
        }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 150;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
        }
        .modal-active { display: flex; }

        @keyframes popIn {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop { animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        .modal-content {
            background: linear-gradient(180deg,#3d3836,#302b29 20.9%), linear-gradient(180deg,#3d3836,#302b29 20.9%);
            border: 2px solid #000;
            border-radius: 20px;
            box-shadow: inset 0 3px 0 0 hsla(0,0%,100%,.1);
            padding: 1.5rem;
            max-width: 48rem;
            width: 100%;
            margin-left: 1rem;
            margin-right: 1rem;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
            filter: drop-shadow(0 12px 6px rgba(0,0,0,.7));
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 2px solid rgba(255,255,255,0.1);
            padding-bottom: 1rem;
        }

        .modal-title {
            font-size: 1.5rem;
            line-height: 2rem;
            font-weight: 500;
            color: white;
            font-family: 'Titan One', cursive;
            text-shadow: 2px 2px 0 #000;
            margin: 0;
        }

        .modal-note {
            font-size: 0.75rem;
            color: var(--c-gray-400);
            font-weight: 500;
            margin-top: 0.5rem;
            line-height: 1.2;
        }

        .modal-close-btn {
            top: -8px;
            right: -8px;
            background: linear-gradient(to bottom, var(--clash-red-top), var(--clash-red-bot));
            color: white;
            border-radius: 5px;
            width: 2rem;
            height: 2rem;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 4px 0 #800000, 0 6px 4px rgba(0,0,0,0.4);
            border: none;
        }
        .modal-close-btn:hover { filter: brightness(1.1); }
        .modal-close-btn:active { transform: translateY(4px); box-shadow: 0 0 0 #800000, inset 0 2px 4px rgba(0,0,0,0.4); }

        .search-input {
            background: #1a1b1e;
            border: 2px solid #000;
            color: white;
            padding: 10px;
            border-radius: 12px;
            width: 100%;
            font-family: 'Rubik', sans-serif;
            font-size: 16px;
            margin-bottom: 16px;
            box-shadow: inset 0 2px 0 0 hsla(0,0%,100%,.1);
        }

        .modal-items-container {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            overflow-y: auto;
            padding-right: 0.5rem;
            flex: 1;
        }
        /* Custom Scrollbar for modal */
        .modal-items-container::-webkit-scrollbar { width: 6px; }
        .modal-items-container::-webkit-scrollbar-track { background: #1a1a1a; border-radius: 3px; }
        .modal-items-container::-webkit-scrollbar-thumb { background: #555; border-radius: 3px; }

        .category-header {
            color: var(--c-gray-400);
            font-weight: 500;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            font-size: 0.875rem;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #4b5563;
            padding-bottom: 0.25rem;
            font-family: 'Titan One', cursive;
        }

        .modal-item-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }
        @media (min-width: 640px) {
            .modal-item-grid { grid-template-columns: repeat(4, 1fr); gap: 1rem; }
        }
        @media (min-width: 768px) {
            .modal-item-grid { grid-template-columns: repeat(5, 1fr); }
        }


        .modal-item-btn {
            min-width: 100px;
            background: radial-gradient(55.62% 55.62% at 50% 50%,#857654 .5%,#301b14 68.75%,#1d1816 97.12%);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            position: relative;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
            scroll-snap-align: start;
            cursor: pointer;
        }

        .modal-item-btn::before {
            content: "";
            position: absolute;
            inset: 0 0;
            padding: 2px;
            z-index: 1;
            background: linear-gradient(rgba(222,185,126,.3),rgba(0,0,0,.1));
            -webkit-mask: linear-gradient(white 0 0) content-box,linear-gradient(white 0 0);
            mask: linear-gradient(white 0 0) content-box,linear-gradient(white 0 0);
              mask-composite: add, add;
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            border-radius: inherit;
            pointer-events: none;
        }

        .modal-item-img {
            width: 2.5rem;
            height: 2.5rem;
            object-fit: contain;
            margin-bottom: 0.5rem;
            filter: drop-shadow(0 10px 8px rgb(0 0 0 / 0.04)) drop-shadow(0 4px 3px rgb(0 0 0 / 0.1));
            transition: transform 0.15s;
        }
        .modal-item-btn:hover .modal-item-img { transform: scale(1.1); }

        .modal-item-name {
            color: var(--c-gray-200);
            font-weight: 500;
            line-height: 1.25;
            text-transform: uppercase;
            letter-spacing: -0.025em;
            font-size: 11px;
            text-align: center;
        }

        .modal-item-value-badge {
            margin-top: 0.5rem;
            background: #000;
            box-shadow: inset 0 2px 0 0 hsla(0,0%,100%,.2);
            border-radius: 0.25rem;
            padding: 0.125rem 0.5rem;
        }

        .modal-item-value-text {
            color: var(--c-green-400);
            font-size: 10px;
        }

        /* --- TUTORIAL & TOAST --- */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .tutorial-step {
            position: fixed;
            max-width: 350px;
            width: 90%; 
            background: #fff;
            color: #333;
            padding: 20px;
            border-radius: 12px;
            border: 4px solid #333;
            box-shadow: 10px 10px 0 rgba(0,0,0,0.5);
            animation: popIn 0.3s;
            z-index: 200;
        }

        .tutorial-title {
            color: #d15600;
            text-shadow: none;
            margin-bottom: 8px;
            font-size: 1.25rem;
            font-weight: 500;
            margin-top: 0;
        }

        .tutorial-text {
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
            font-weight: 500;
            margin-top: 0;
        }

        .tutorial-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tutorial-skip-btn {
            background: none;
            border: none;
            font-size: 0.75rem;
            color: var(--c-gray-500);
            font-weight: 500;
            text-decoration: underline;
            cursor: pointer;
            transition: color 0.15s;
        }
        .tutorial-skip-btn:hover { color: var(--c-gray-800); }

        .tutorial-next-btn {
            background: linear-gradient(to bottom, var(--clash-green-top), var(--clash-green-bot));
            border-radius: 8px;
            color: white;
            box-shadow: 0 4px 0 #3a5700, 0 6px 4px rgba(0,0,0,0.4);
            border: none;
            cursor: pointer;
            padding: 0.5rem 1.5rem;
            font-size: 0.875rem;
            font-family: 'Titan One', cursive;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .tutorial-next-btn:active { transform: translateY(4px); box-shadow: 0 0 0 #3a5700, inset 0 2px 4px rgba(0,0,0,0.4); }
        .tutorial-next-btn:disabled { opacity: 0.6; filter: grayscale(0.8); cursor: not-allowed; }

        .highlight-target {
            z-index: 101; 
            position: relative;
            box-shadow: 0 0 0 4px #ffee00, 0 0 20px 10px rgba(255, 238, 0, 0.5); 
            border-radius: 8px;
            transform: scale(1.02);
            transition: all 0.3s;
            pointer-events: auto; 
        }
        
        .lift-z-index {
            z-index: 102 !important;
            position: relative !important;
        }

        #toast {
            visibility: hidden;
            min-width: 250px;
            width: 80%;
            background: linear-gradient(to bottom, var(--clash-blue-top), var(--clash-blue-bot));
            color: #fff;
            text-align: center;
            border-radius: 15px;
            padding: 16px;
            position: fixed;
            z-index: 300;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            box-shadow: 0 4px 0 #004080, 0 6px 4px rgba(0,0,0,0.4), inset 0 3px 0 0 hsla(0,0%,100%,.1);
        }
        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

    </style>
</head>
<body class="app-container">

    <!-- TUTORIAL OVERLAY -->
    <div id="tutorial-overlay" class="tutorial-overlay"></div>
    <!-- TUTORIAL POPOVER -->
    <div id="tutorial-popover" class="tutorial-step hidden">
        <h4 class="tutorial-title" id="tutorial-title"></h4>
        <p class="tutorial-text" id="tutorial-text"></p>
        <div class="tutorial-actions">
            <button onclick="skipTutorial()" class="tutorial-skip-btn">Skip</button>
            <button onclick="nextTutorialStep()" id="tutorial-next-button" class="tutorial-next-btn">Next Step <i class="fa-solid fa-arrow-right"></i></button>
        </div>
    </div>
    
    <!-- TOAST NOTIFICATION -->
    <div id="toast">Link copied to clipboard!</div>
    
    <!-- 1. TOP SECTION: Gem Pack Reference -->
    <section class="gem-section">
        <div class="section-header">
            <i class="fa-solid fa-gem section-icon-gem"></i>
            <h2 class="section-title">Gem Pack Prices</h2>
        </div>
        <div class="clash-panel">
            <div class="gem-scroll-container" id="gem-packs-container">
                <!-- Gem Cards generated by JS -->
            </div>
        </div>
    </section>

    <!-- 2. OFFERS SECTION -->
    <section class="offers-section"> 
        <!-- Control Bar -->
        <div class="control-bar">
            <div class="section-header">
                <i class="fa-solid fa-scroll section-icon-scroll"></i>
                <h2 class="section-title">Your Offers</h2>
            </div>
            
            <div class="action-group">
                <!-- Compact Toggle -->
                <div class="compact-toggle-container">
                    <span class="compact-label">Compact</span>
                    <div class="toggle-wrapper">
                        <input type="checkbox" name="toggle" id="compact-toggle" class="toggle-checkbox" onclick="toggleCompactMode()"/>
                        <label for="compact-toggle" class="toggle-track"></label>
                    </div>
                </div>

                <!-- Action Buttons -->
                <button onclick="shareConfiguration()" class="btn-share">
                    <i class="fa-solid fa-share-nodes"></i> Share
                </button>
                <button onclick="clearAllOffers()" class="btn-clear">
                    <i class="fa-solid fa-trash"></i> Clear All
                </button>
            </div>
        </div>

        <div id="offers-container">
            <!-- Offer rows generated by JS -->
        </div>
    </section>

    <!-- 3. ADD OFFER BUTTON -->
    <button onclick="addNewOffer()" class="btn-add-offer group">
        <div class="btn-add-icon-wrapper">
            <i class="fa-solid fa-plus"></i>
        </div>
        Add New Offer
    </button>


    <!-- MODAL: Item Selection -->
    <div id="item-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content animate-pop" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title">Select Item</h3>
                <button onclick="closeModal()" class="modal-close-btn"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <!-- Search Input -->
            <input type="text" id="modal-search" placeholder="Search items..." class="search-input" onkeyup="filterModalItems()">

            <!-- Categories and Items -->
            <div class="modal-items-container" id="modal-items-container">
                <!-- Generated by JS -->
            </div>
        </div>
    </div>

    <script>
        // --- DATA CONSTANTS ---
        const GEM_PACK_DATA = [
            { gems: 80, image: "img/Clash_Gems_Pocket.png" },
            { gems: 500, image: "img/Clash_Gems_Pile.png" },
            { gems: 1200, image: "img/Clash_Gems_Bag.png" },
            { gems: 2500, image: "img/Clash_Gems_Sack.png" },
            { gems: 6500, image: "img/Clash_Gems_Box.png" },
            { gems: 14000, image: "img/Clash_Gems_Chest.png" }
        ];

        const ITEM_VALUES = {
            "Gems": { value: 1, image: "img/Icon_HV_Resource_Gem.png" },
            "Book of Heroes": { value: 500, image: "img/Magic_Item_Book_of_Heroes.png" },
            "Book of Fighting": { value: 925, image: "img/Magic_Item_Book_of_Troops.png" },
            "Book of Building": { value: 925, image: "img/Magic_Item_Book_of_Buildings.png" },
            "Book of Spells": { value: 925, image: "img/Magic_Item_Book_of_Spells.png" },
            "Book of Everything": { value: 1000, image: "img/Magic_Item_Book_of_Everything.png" },
            "Rune of Gold": { value: 1000, image: "img/Magic_Item_Rune_of_Gold.png" },
            "Rune of Elixir": { value: 1000, image: "img/Magic_Item_Rune_of_Elixir.png" },
            "Rune of DE": { value: 2000, image: "img/Magic_Item_Rune_of_Dark_Elixir.png" },
            "Rune of Builder Elixir": { value: 1000, image: "img/Magic_Item_Rune_of_Builder_Elixir.png" },
            "Rune of Builder Gold": { value: 1000, image: "img/Magic_Item_Rune_of_Builder_Gold.png" },
            "Wall Ring": { value: 35, image: "img/Magic_Item_Wall_Ring.png" },
            "Builder Potion": { value: 285, image: "img/Magic_Item_Builder_Potion.png" },
            "Research Potion": { value: 120, image: "img/Magic_Item_Research_Potion.png" },
            "Hero Potion": { value: 150, image: "img/Magic_Item_Hero_Potion.png" },
            "Pet Potion": { value: 120, image: "img/Magic_Item_Pet_Potion.png" },
            "Power Potion": { value: 150, image: "img/Magic_Item_Power_Potion.png" },
            "Resource Potion": { value: 60, image: "img/Magic_Item_Resource_Potion.png" },
            "Clock Tower Potion": { value: 75, image: "img/Magic_Item_Clock_Tower_Potion.png" },
            "Super Potion": { value: 300, image: "img/Magic_Item_Super_Troop_Potion.png" },
            "Shovel": { value: 500, image: "img/Magic_Item_Shovel_of_Obstacles.png" },
            "Shiny Ore": { value: 0.5, image: "img/Icon_HV_Resource_Shiny_Ore.png" },
            "Glowy Ore": { value: 2.5, image: "img/Icon_HV_Resource_Glowy_Ore.png" },
            "Starry Ore": { value: 18.3, image: "img/Icon_HV_Resource_Starry_Ore.png" },
            "Builder Star Jar": { value: 100, image: "img/Magic_Item_Builder_Star_Jar.png" },
            "Epic Hero Equipment": { value: 1500, image: "img/Hero_Equipment_BQ_Giant_Gauntlet.png" },
            "Hammer of Fighting": { value: 1925, image: "img/Magic_Item_Hammer_of_Troops.png" },
            "Hammer of Building": { value: 1925, image: "img/Magic_Item_Hammer_of_Buildings.png" },
            "Hammer of Spells": { value: 1925, image: "img/Magic_Item_Hammer_of_Spells.png" },
            "Hammer of Heroes": { value: 2500, image: "img/Magic_Item_Hammer_of_Heroes.png" },
        };
        
        const CATEGORIES = {
            "Currency": ["Gems"],
            "Books": ["Book of Heroes", "Book of Fighting", "Book of Building", "Book of Spells", "Book of Everything"],
            "Runes": ["Rune of Gold", "Rune of Elixir", "Rune of DE", "Rune of Builder Elixir", "Rune of Builder Gold"],
            "Potions": ["Builder Potion", "Research Potion", "Hero Potion", "Pet Potion", "Power Potion", "Resource Potion", "Clock Tower Potion", "Super Potion"],
            "Ores": ["Shiny Ore", "Glowy Ore", "Starry Ore"],
            "Hammers": ["Hammer of Fighting", "Hammer of Building", "Hammer of Spells", "Hammer of Heroes"],
            "Others": ["Wall Ring", "Shovel", "Builder Star Jar", "Epic Hero Equipment"]
        };
        
        // --- STATE ---
        let offers = []; 
        let activeOfferIdForModal = null;
        let tutorialStep = 0;
        let tutorialActive = false;
        let currencySymbol = '$';

        // --- TUTORIAL ---
        const TUTORIAL_STEPS = [
            {
                title: "Welcome Chief!",
                text: "To start, we need to set the standard market rate. Please enter the real-world price (e.g. 99.99) for the 14,000 Gem pack above.",
                target: () => document.querySelector('.gem-price-input[data-gems="14000"]'),
                position: 'bottom-right'
            },
            {
                title: "Offer Cost",
                text: "Great! Now look at the offer you want to buy. Enter its real-world price here.",
                target: () => document.querySelector(`#offer-row-${offers[0]?.id} .price-input`),
                position: 'right'
            },
            {
                title: "Add Items",
                text: "What's inside the offer? Tap this '+' button to add items.",
                target: () => document.querySelector(`#offer-row-${offers[0]?.id} .add-item-card`),
                position: 'right'
            },
            {
                title: "Select an Item",
                text: "Tap an item to add it to your offer calculation.",
                target: () => document.querySelector('#modal-items-container .modal-item-btn'), 
                position: 'right'
            },
            {
                title: "Value Rating",
                text: "Here is your Value Rating! 2x or higher is usually a great deal. Good luck Chief!",
                target: () => document.querySelector(`#offer-row-${offers[0]?.id} .offer-result-area`),
                position: 'left'
            }
        ];

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            currencySymbol = detectCurrencySymbol();
            
            renderGemPacks();
            loadStoredPrices();
            
            const hasSharedData = loadFromURL();
            if (!hasSharedData) {
                loadOffersFromStorage();
            }

            if (offers.length === 0) {
                addNewOffer(false); 
            } else {
                renderOffers();
            }
            
            renderModalItems();
            setTimeout(() => checkTutorialState(), 500);
        });
        
        // --- CURRENCY DETECTION ---
        function detectCurrencySymbol() {
            const lang = navigator.language || 'en-US';
            let region = null;
            
            if (lang.indexOf('-') > -1) {
                region = lang.split('-')[1].toUpperCase();
            } else if (lang.indexOf('_') > -1) {
                region = lang.split('_')[1].toUpperCase();
            }

            const regionCurrency = {
                'US': '$', 'CA': '$', 'MX': '$', 'BM': '$',
                'AT': '€', 'BE': '€', 'CY': '€', 'EE': '€', 'FI': '€', 'FR': '€', 'DE': '€', 
                'GR': '€', 'IE': '€', 'IT': '€', 'LV': '€', 'LT': '€', 'LU': '€', 'MT': '€', 
                'NL': '€', 'PT': '€', 'SK': '€', 'SI': '€', 'ES': '€', 'HR': '€', 'AD': '€',
                'MC': '€', 'SM': '€', 'VA': '€', 'ME': '€', 'XK': '€',
                'GB': '£', 'IM': '£', 'GG': '£', 'JE': '£',
                'CH': 'Fr', 'LI': 'Fr',
                'SE': 'kr', 'NO': 'kr', 'DK': 'kr', 'IS': 'kr',
                'CZ': 'Kč', 'PL': 'zł', 'HU': 'Ft', 'RO': 'lei', 'BG': 'лв',
                'UA': '₴', 'BY': 'Br', 'MD': 'L', 'RS': 'дин', 'MK': 'ден', 'BA': 'KM', 'AL': 'L',
                'RU': '₽',
                'JP': '¥', 'CN': '¥', 'HK': '$', 'TW': 'NT$', 'MO': 'P',
                'IN': '₹', 'PK': '₨', 'LK': '₨', 'NP': '₨', 'BD': '৳',
                'KR': '₩',
                'SG': '$', 'MY': 'RM', 'ID': 'Rp', 'TH': '฿', 'PH': '₱', 'VN': '₫',
                'KH': '៛', 'LA': '₭', 'MM': 'Ks', 'MN': '₮',
                'TR': '₺', 'IL': '₪', 'SA': '﷼', 'AE': 'د.إ', 'QA': 'ر.ق', 'KW': 'د.ك',
                'OM': 'ر.ع', 'BH': 'د.ب', 'JO': 'د.ا', 'LB': 'ل.ل', 'EG': 'E£', 'IR': '﷼',
                'BR': 'R$', 'AR': '$', 'CL': '$', 'CO': '$', 'PE': 'S/', 'UY': '$U',
                'PY': 'Gs', 'BO': 'Bs', 'VE': 'Bs', 'EC': '$',
                'AU': '$', 'NZ': '$', 'FJ': '$', 'PG': 'K',
                'ZA': 'R', 'NG': '₦', 'GH': '₵', 'KE': 'Sh', 'TZ': 'Sh', 'UG': 'Sh',
                'MA': 'د.م.', 'DZ': 'د.ج', 'TN': 'د.ت', 'ET': 'Br'
            };

            const langCurrency = {
                'en': '$',
                'de': '€', 'fr': '€', 'it': '€', 'es': '€', 'pt': '€', 'nl': '€', 'el': '€',
                'ja': '¥', 'zh': '¥', 'hi': '₹', 'ru': '₽', 'ko': '₩', 'tr': '₺', 'pl': 'zł',
                'sv': 'kr', 'id': 'Rp', 'th': '฿', 'vi': '₫', 'ar': '﷼'
            };

            if (region && regionCurrency[region]) return regionCurrency[region];
            const langCode = lang.split('-')[0].split('_')[0].toLowerCase();
            if (langCurrency[langCode]) return langCurrency[langCode];
            return '$';
        }

        // --- STORAGE & SHARING LOGIC ---

        function saveOffersToStorage() {
            localStorage.setItem('coc_offers', JSON.stringify(offers));
        }

        function loadOffersFromStorage() {
            const stored = localStorage.getItem('coc_offers');
            if (stored) {
                try {
                    offers = JSON.parse(stored);
                } catch(e) {
                    console.error("Failed to load offers", e);
                    offers = [];
                }
            }
        }

        function clearAllOffers() {
            if(confirm("Are you sure you want to clear all offers?")) {
                offers = [];
                document.getElementById('offers-container').innerHTML = '';
                addNewOffer();
                saveOffersToStorage();
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        function shareConfiguration() {
            const itemKeys = Object.keys(ITEM_VALUES).sort();
            
            // 1. Minify Offers
            const minifiedOffers = offers.map(o => {
                const minItems = o.items.map(i => {
                    const idx = itemKeys.indexOf(i.name);
                    return [idx, parseFloat(i.qty) || 0];
                });
                return [parseFloat(o.price) || 0, minItems];
            });

            // 2. Gather Gem Prices (in order of GEM_PACK_DATA)
            const prices = GEM_PACK_DATA.map(pack => {
                const input = document.querySelector(`.gem-price-input[data-gems="${pack.gems}"]`);
                return input ? (parseFloat(input.value) || 0) : 0;
            });

            // 3. Construct Payload
            // Legacy was just minifiedOffers array. New is { o: offers, p: prices }
            const payload = {
                o: minifiedOffers,
                p: prices
            };

            const jsonString = JSON.stringify(payload);
            const b64 = btoa(jsonString);
            
            const url = `${window.location.protocol}//${window.location.host}${window.location.pathname}?s=${b64}`;
            
            navigator.clipboard.writeText(url).then(() => {
                showToast("Short link copied to clipboard!");
            }).catch(err => {
                console.error('Could not copy text: ', err);
                prompt("Copy this link:", url);
            });
        }
        
        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.textContent = message;
            toast.className = "show";
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }

        function loadFromURL() {
            const params = new URLSearchParams(window.location.search);
            const shareData = params.get('s');
            
            if (shareData) {
                try {
                    const json = atob(shareData);
                    const parsed = JSON.parse(json);
                    
                    let minifiedOffers = [];
                    let importedPrices = [];

                    // Check format: Array (legacy) or Object (new)
                    if (Array.isArray(parsed)) {
                        minifiedOffers = parsed;
                    } else if (typeof parsed === 'object' && parsed !== null) {
                        minifiedOffers = parsed.o || [];
                        importedPrices = parsed.p || [];
                    }

                    // --- Process Offers ---
                    const itemKeys = Object.keys(ITEM_VALUES).sort();
                    
                    if (minifiedOffers.length > 0) {
                        offers = minifiedOffers.map(minOffer => {
                            const [price, minItems] = minOffer;
                            const items = minItems.map(mi => {
                                const [idx, qty] = mi;
                                return { name: itemKeys[idx], qty: qty };
                            });
                            return { id: Date.now() + Math.random(), price, items };
                        });
                    }

                    // --- Process Prices ---
                    if (importedPrices.length > 0) {
                        // We apply them to the DOM inputs
                        // They are ordered by GEM_PACK_DATA index
                        GEM_PACK_DATA.forEach((pack, index) => {
                            if (importedPrices[index] !== undefined && importedPrices[index] > 0) {
                                const input = document.querySelector(`.gem-price-input[data-gems="${pack.gems}"]`);
                                if (input) {
                                    input.value = importedPrices[index];
                                }
                            }
                        });
                        // Save to storage immediately so they persist
                        savePrices();
                        // Recalculate will happen in main init after this function returns true
                        // or we can force it here, but main init calls renderGemPacks->loadStoredPrices->recalculate
                        // Wait, loadStoredPrices might overwrite what we just set if we don't save.
                        // We saved, so loadStoredPrices will pick it up.
                    }

                    return true;
                } catch (e) {
                    console.error("Invalid short share data", e);
                }
            }

            // Legacy 'data' param support
            const data = params.get('data');
            if (data) {
                try {
                    const parsedOffers = JSON.parse(decodeURIComponent(data));
                    if (Array.isArray(parsedOffers) && parsedOffers.length > 0) {
                        offers = parsedOffers;
                        return true;
                    }
                } catch (e) {
                    console.error("Invalid shared data", e);
                }
            }
            return false;
        }

        // --- TUTORIAL LOGIC ---
        function checkTutorialState() {
            if (localStorage.getItem('coc_tutorial_complete') !== 'true') {
                tutorialActive = true; 
                document.getElementById('tutorial-overlay').style.display = 'flex';
                showTutorialStep(0);
                localStorage.setItem('coc_tutorial_complete', 'true');
            }
        }

        function skipTutorial() {
            tutorialActive = false; 
            document.getElementById('tutorial-overlay').style.display = 'none';
            document.getElementById('tutorial-popover').classList.add('hidden'); 
            document.querySelectorAll('.highlight-target').forEach(el => el.classList.remove('highlight-target'));
            document.querySelectorAll('.lift-z-index').forEach(el => el.classList.remove('lift-z-index'));
        }

        function nextTutorialStep() {
            if (!tutorialActive) return;

            if (tutorialStep === 0) {
                const input = TUTORIAL_STEPS[0].target();
                if (!input || parseFloat(input.value) <= 0) { input?.focus(); return; }
            } else if (tutorialStep === 1) {
                const input = TUTORIAL_STEPS[1].target();
                if (!input || parseFloat(input.value) <= 0) { input?.focus(); return; }
            }
            
            if (tutorialStep >= TUTORIAL_STEPS.length - 1) {
                skipTutorial();
                return;
            }

            tutorialStep++;
            showTutorialStep(tutorialStep);
        }

        function validateTutorialStep() {
            if (!tutorialActive) return;
            
            const nextButton = document.getElementById('tutorial-next-button');
            let isValid = false;

            if (tutorialStep === 0) {
                const input = TUTORIAL_STEPS[0].target();
                if (input && parseFloat(input.value) > 0) {
                    isValid = true;
                }
            } else if (tutorialStep === 1) {
                const input = TUTORIAL_STEPS[1].target();
                if (input && parseFloat(input.value) > 0) {
                    isValid = true;
                }
            }

            if (isValid) {
                nextButton.disabled = false;
            } else {
                nextButton.disabled = true;
            }
        }

        function showTutorialStep(stepIndex) {
            if (!tutorialActive) return;

            const step = TUTORIAL_STEPS[stepIndex];
            const popover = document.getElementById('tutorial-popover');
            const nextButton = document.getElementById('tutorial-next-button');
            const target = step.target();

            document.querySelectorAll('.highlight-target').forEach(el => el.classList.remove('highlight-target'));
            document.querySelectorAll('.lift-z-index').forEach(el => el.classList.remove('lift-z-index'));

            if (!target) {
                popover.classList.add('hidden');
                return;
            }

            nextButton.style.display = 'flex';
            nextButton.disabled = false;

            if (stepIndex === 0 || stepIndex === 1) {
                 validateTutorialStep();
            } else if (stepIndex === 2 || stepIndex === 3) {
                nextButton.style.display = 'none';
            }
            
            nextButton.innerHTML = (stepIndex === TUTORIAL_STEPS.length - 1) 
                ? 'Finish <i class="fa-solid fa-check ml-1"></i>' 
                : 'Next <i class="fa-solid fa-arrow-right"></i>';

            target.classList.add('highlight-target');
            
            const parentRow = target.closest('.offer-row');
            if (parentRow) parentRow.classList.add('lift-z-index');
            
            const parentPanel = target.closest('.clash-panel');
            if (parentPanel) parentPanel.classList.add('lift-z-index');
            
            target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            document.getElementById('tutorial-title').textContent = step.title;
            document.getElementById('tutorial-text').textContent = step.text;

            const targetRect = target.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            popover.classList.remove('hidden');
            popover.style.transform = 'none';
            
            let top = targetRect.bottom + 10;
            let left = targetRect.left;

             if (step.position === 'bottom-right') {
                left = targetRect.right - popover.offsetWidth;
            } else if (step.position === 'right') {
                top = targetRect.top;
                left = targetRect.right + 15;
            } else if (step.position === 'left') {
                top = targetRect.top;
                left = targetRect.left - popover.offsetWidth - 15;
            } 
            
            if (left < 10) left = 10;
            if (left + popover.offsetWidth > viewportWidth) left = viewportWidth - popover.offsetWidth - 10;
            if (top + popover.offsetHeight > viewportHeight) top = targetRect.top - popover.offsetHeight - 10;

            popover.style.top = `${top}px`;
            popover.style.left = `${left}px`;

            if (stepIndex === 1) step.target()?.focus();
        }

        // --- GEM PACKS LOGIC ---
        function renderGemPacks() {
            const container = document.getElementById('gem-packs-container');
            container.innerHTML = '';
            
            GEM_PACK_DATA.forEach(pack => {
                const card = document.createElement('div');
                card.className = "gem-pack-card";
                card.innerHTML = `
                    <div class="gem-amount-text">${pack.gems.toLocaleString()}</div>
                    <img src="${pack.image}" 
                            class="gem-image"
                            onerror="this.onerror=null;this.src='https://placehold.co/40x40/1a1a1d/ffffff?text=?';"
                            alt="${pack.gems} Gems">
                    <div class="gem-input-wrapper">
                        <input type="number" step="0.01" data-gems="${pack.gems}" 
                            class="gem-price-input" 
                            placeholder="0.00" oninput="handlePriceChange()">
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function handlePriceChange() {
            savePrices();
            recalculateAllOffers();
            
            if (tutorialActive && tutorialStep === 0) {
                validateTutorialStep();
            }
        }

        function savePrices() {
            const inputs = document.querySelectorAll('.gem-price-input');
            const prices = {};
            inputs.forEach(input => {
                prices[input.dataset.gems] = input.value;
            });
            localStorage.setItem('coc_gem_prices_v2', JSON.stringify(prices));
        }

        function loadStoredPrices() {
            const stored = localStorage.getItem('coc_gem_prices_v2') || localStorage.getItem('coc_gem_prices'); 
            if (stored) {
                const prices = JSON.parse(stored);
                setTimeout(() => {
                    const inputs = document.querySelectorAll('.gem-price-input');
                    inputs.forEach(input => {
                        if (prices[input.dataset.gems]) {
                            input.value = prices[input.dataset.gems];
                        }
                    });
                    recalculateAllOffers();
                }, 0);
            }
        }

        // --- OFFERS LOGIC ---

        function addNewOffer(save = true) {
            const id = Date.now();
            const newOffer = {
                id: id,
                price: 0,
                items: []
            };
            offers.push(newOffer);
            if(save) saveOffersToStorage();
            
            const container = document.getElementById('offers-container');
            container.appendChild(createOfferRowElement(newOffer));

             if (offers.length === 1 && tutorialActive) {
                 if (tutorialStep === 0) setTimeout(() => showTutorialStep(0), 100);
             }
        }

        function deleteOffer(id) {
            if (tutorialActive) {
                showToast("Cannot delete items during tutorial!");
                return;
            }
            offers = offers.filter(o => o.id !== id);
            saveOffersToStorage();
            const row = document.getElementById(`offer-row-${id}`);
            if(row) row.remove();
        }

        function addItemToOffer(itemName) {
            if (!activeOfferIdForModal) return;
            
            const offer = offers.find(o => o.id === activeOfferIdForModal);
            if (offer) {
                offer.items.push({
                    name: itemName,
                    qty: 1
                });
                saveOffersToStorage();
                refreshOfferRow(activeOfferIdForModal);
                
                closeModal(null, true);

                if (tutorialActive && tutorialStep === 3) {
                    if (offers.length === 1 && offers[0].items.length === 1) {
                         tutorialStep = 4;
                         setTimeout(() => showTutorialStep(4), 100);
                    }
                }
            }
        }

        function deleteItemFromOffer(offerId, itemIndex) {
            const offer = offers.find(o => o.id === offerId);
            if (offer) {
                offer.items.splice(itemIndex, 1);
                saveOffersToStorage();
                refreshOfferRow(offerId);
            }
        }

        function updateOfferPrice(id, newPrice) {
            const offer = offers.find(o => o.id === id);
            if (offer) {
                offer.price = parseFloat(newPrice) || 0;
                saveOffersToStorage();
                updateOfferResultUI(id); 
                
                if (tutorialActive && tutorialStep === 1) {
                    validateTutorialStep();
                }
            }
        }

        function updateItemQty(offerId, itemIndex, newQty) {
            const offer = offers.find(o => o.id === offerId);
            if (offer) {
                offer.items[itemIndex].qty = parseFloat(newQty) || 0;
                saveOffersToStorage();
                updateOfferResultUI(offerId);
            }
        }

        // --- UI ---
        
        function toggleCompactMode() {
            document.body.classList.toggle('compact-mode');
        }

        function generateOfferRowContent(offer) {
            const calculation = calculateSingleOffer(offer);
            
            let itemsHtml = '';
            offer.items.forEach((item, idx) => {
                const itemData = ITEM_VALUES[item.name];
                itemsHtml += `
                    <div class="offer-card">
                        <div onclick="deleteItemFromOffer(${offer.id}, ${idx})" class="item-delete-btn"><i class="fa-solid fa-times"></i></div>
                        <div class="item-name-text">${item.name}</div>
                        <img src="${itemData.image}" 
                                onerror="this.onerror=null;this.src='https://placehold.co/32x32/38383b/white?text=?';" 
                                class="item-card-image" alt="${item.name}">
                        <div class="item-qty-wrapper">
                            <input type="number" value="${item.qty}" min="1" 
                                class="item-qty-input"
                                oninput="updateItemQty(${offer.id}, ${idx}, this.value)">
                        </div>
                    </div>
                `;
            });

            // Note: Dynamic styles for calculation result colors are added inline or via helper classes if needed, 
            // but for simplicity we keep the inline style/class approach from before for the dynamic parts.
            // However, we will use our new CSS variables where possible.
            
            let resultColorClass = '';
            let starsHtml = '';
            
            // Re-implement logic to match new CSS structure slightly better
            // Ideally this logic is in 'calculateSingleOffer' but we need to map to classes here.
            // The existing 'calculation.colorClass' returned tailwind classes. Let's fix that.
            
            const calc = calculateSingleOffer(offer);
            // We need to map the tailwind color class to a style or a specific class
            let colorStyle = 'color: white;';
            if (calc.colorClass.includes('red')) colorStyle = 'color: var(--c-red-400);';
            else if (calc.colorClass.includes('gray')) colorStyle = 'color: var(--c-gray-300);';
            else if (calc.colorClass.includes('yellow')) colorStyle = 'color: var(--c-yellow-400);';
            else if (calc.colorClass.includes('purple')) colorStyle = 'color: var(--c-purple-400);';

            return `
                <button onclick="deleteOffer(${offer.id})" class="delete-offer-btn">Delete</button>

                <div class="offer-scroll-area">
                    <div class="offer-card">
                        <div class="price-label">Price</div>
                        <span class="price-symbol">${currencySymbol}</span>
                        <div class="price-input-wrapper">
                            <input type="number" step="0.01" value="${offer.price || ''}" 
                                class="price-input" placeholder="0.00"
                                oninput="updateOfferPrice(${offer.id}, this.value)">
                        </div>
                    </div>

                    ${itemsHtml}

                    <div onclick="openItemModal(${offer.id})" class="add-item-card">
                        <i class="fa-solid fa-plus add-item-icon"></i>
                    </div>
                </div>

                <div class="offer-result-area">
                    <div class="result-label">Value</div>
                    <div class="result-multiplier" id="result-val-${offer.id}" style="${colorStyle}">${calc.multiplier}x</div>
                    <div class="result-stars" id="result-stars-${offer.id}">${calc.starsHtml}</div>
                    <div class="result-gems" id="result-gem-${offer.id}">${calc.totalGems.toLocaleString()} Gems</div>
                </div>
            `;
        }

        function createOfferRowElement(offer) {
            const row = document.createElement('div');
            row.className = "offer-row animate-pop group";
            row.id = `offer-row-${offer.id}`;
            row.innerHTML = generateOfferRowContent(offer);
            return row;
        }

        function renderOffers() {
            const container = document.getElementById('offers-container');
            container.innerHTML = '';

            offers.forEach(offer => {
                container.appendChild(createOfferRowElement(offer));
            });
            
            if (tutorialActive) {
                if (tutorialStep === 0) setTimeout(() => showTutorialStep(0), 100); 
                else if (tutorialStep === 1 && offers[0].price === 0) setTimeout(() => showTutorialStep(1), 100);
                else if (tutorialStep === 2) setTimeout(() => showTutorialStep(2), 100);
            }
        }

        function refreshOfferRow(offerId) {
             const offer = offers.find(o => o.id === offerId);
             if(!offer) return;
             const row = document.getElementById(`offer-row-${offerId}`);
             if(row) {
                 row.innerHTML = generateOfferRowContent(offer);
             }
        }

        // --- CALCULATION LOGIC ---

        function recalculateAllOffers() {
            offers.forEach(offer => updateOfferResultUI(offer.id));
        }

        function updateOfferResultUI(offerId) {
            const offer = offers.find(o => o.id === offerId);
            if (!offer) return;
            
            const calc = calculateSingleOffer(offer);
            
            const resultValEl = document.getElementById(`result-val-${offerId}`);
            const resultGemEl = document.getElementById(`result-gem-${offerId}`);
            const resultStarsEl = document.getElementById(`result-stars-${offerId}`);
            
            if(resultValEl) {
                resultValEl.textContent = `${calc.multiplier}x`;
                // Map color class to CSS var
                if (calc.colorClass.includes('red')) resultValEl.style.color = 'var(--c-red-400)';
                else if (calc.colorClass.includes('gray')) resultValEl.style.color = 'var(--c-gray-300)';
                else if (calc.colorClass.includes('yellow')) resultValEl.style.color = 'var(--c-yellow-400)';
                else if (calc.colorClass.includes('purple')) resultValEl.style.color = 'var(--c-purple-400)';
                else resultValEl.style.color = 'white';
            }
            if(resultGemEl) {
                resultGemEl.textContent = `${calc.totalGems.toLocaleString()} Gems`;
            }
            if(resultStarsEl) {
                resultStarsEl.innerHTML = calc.starsHtml;
            }
        }

        function calculateSingleOffer(offer) {
            let totalGems = 0;
            offer.items.forEach(item => {
                const val = ITEM_VALUES[item.name]?.value || 0;
                totalGems += val * (parseFloat(item.qty) || 0);
            });

            if (!offer.price || offer.price <= 0 || totalGems === 0) {
                return { multiplier: '---', totalGems: totalGems, colorClass: 'text-gray-500', starsHtml: '' };
            }

            const packData = getGemPackData();
            let rawCost = 0;
            if (packData.length === 0) {
                rawCost = totalGems * (1/100);
            } else {
                packData.sort((a, b) => (b.price / b.gems) - (a.price / a.gems));
                const bestPack = packData[packData.length - 1]; 
                rawCost = totalGems * (bestPack.price / bestPack.gems);
            }

            const multiplier = rawCost / offer.price;
            const mVal = parseFloat(multiplier.toFixed(1));

            let color = "text-white";
            let starsHtml = "";

            if (mVal < 1.5) {
                color = "text-red-400";
                starsHtml = '<span style="color:var(--c-red-400)">Bad Deal</span>';
            } else if (mVal < 2.0) {
                color = "text-gray-300";
                starsHtml = '<i class="fa-solid fa-star" style="color:var(--c-gray-400)"></i>';
            } else if (mVal < 3.5) {
                color = "text-yellow-400";
                starsHtml = '<i class="fa-solid fa-star" style="color:var(--c-yellow-400)"></i><i class="fa-solid fa-star" style="color:var(--c-yellow-400)"></i>';
            } else {
                color = "text-purple-400";
                starsHtml = '<i class="fa-solid fa-star" style="color:var(--c-yellow-400)"></i><i class="fa-solid fa-star" style="color:var(--c-yellow-400)"></i><i class="fa-solid fa-star" style="color:var(--c-yellow-400)"></i>';
            }

            return {
                multiplier: multiplier.toFixed(1),
                totalGems: totalGems,
                colorClass: color,
                starsHtml: starsHtml
            };
        }

        function getGemPackData() {
            const packs = [];
            const inputs = document.querySelectorAll('.gem-price-input');
            inputs.forEach(input => {
                const gems = parseFloat(input.dataset.gems);
                const price = parseFloat(input.value);
                if (price > 0 && gems > 0) {
                    packs.push({ gems, price });
                }
            });
            return packs;
        }

        // --- MODAL LOGIC ---
        
        function filterModalItems() {
            const searchText = document.getElementById('modal-search').value.toLowerCase();
            const itemBtns = document.querySelectorAll('.modal-item-btn');
            
            itemBtns.forEach(btn => {
                const name = btn.querySelector('.modal-item-name').textContent.toLowerCase();
                if(name.includes(searchText)) {
                    btn.style.display = 'flex';
                } else {
                    btn.style.display = 'none';
                }
            });
            
            document.querySelectorAll('#modal-items-container > div').forEach(catDiv => {
                const visibleItems = catDiv.querySelectorAll('.modal-item-btn[style="display: flex;"], .modal-item-btn:not([style*="display: none"])');
                if(visibleItems.length === 0) {
                    catDiv.style.display = 'none';
                } else {
                    catDiv.style.display = 'block';
                }
            });
        }

        function renderModalItems() {
            const container = document.getElementById('modal-items-container');
            container.innerHTML = '';
            
            for (const [category, items] of Object.entries(CATEGORIES)) {
                const categoryWrapper = document.createElement('div');
                
                const header = document.createElement('h4');
                header.className = "category-header";
                header.textContent = category;
                categoryWrapper.appendChild(header);

                if (category === "Currency" && items.includes("Gems")) {
                    const note = document.createElement('p');
                    note.className = "modal-note";
                    note.innerHTML = 'Tip: You can use approximate gem value as a replacement for any special item that is not listed here.';
                    categoryWrapper.appendChild(note);
                }

                const grid = document.createElement('div');
                grid.className = "modal-item-grid";
                
                items.forEach(name => {
                    const data = ITEM_VALUES[name];
                    if (!data) return; 

                    const btn = document.createElement('div');
                    btn.className = "modal-item-btn";
                    btn.onclick = () => addItemToOffer(name);
                    btn.innerHTML = `
                        <img src="${data.image}" 
                            onerror="this.onerror=null;this.src='https://placehold.co/32x32/38383b/white?text=?';" 
                            class="modal-item-img" alt="${name}">
                        <span class="modal-item-name">${name}</span>
                        <div class="modal-item-value-badge">
                            <span class="modal-item-value-text">${data.value}</span>
                        </div>
                    `;
                    grid.appendChild(btn);
                });

                categoryWrapper.appendChild(grid);
                container.appendChild(categoryWrapper);
            }
        }

        function openItemModal(offerId) {
            if (tutorialActive && tutorialStep < 2) {
                showToast("Please enter prices first!");
                document.querySelector(`#offer-row-${offerId} .price-input`).focus();
                return;
            }

            activeOfferIdForModal = offerId;
            document.getElementById('item-modal').classList.add('modal-active');
            
            setTimeout(() => document.getElementById('modal-search').focus(), 100);
            
            if (tutorialActive && tutorialStep === 2) {
                tutorialStep = 3; 
                setTimeout(() => showTutorialStep(3), 100);
            }
        }

        function closeModal(event, force = false) {
            if (!force && tutorialActive && tutorialStep === 3) {
                showToast("Please select an item to continue!");
                return;
            }

            if (event && event.target !== document.getElementById('item-modal') && !event.target.closest('#item-modal button')) return; 
            document.getElementById('item-modal').classList.remove('modal-active');
            activeOfferIdForModal = null;
        }

    </script>
</body>
</html>