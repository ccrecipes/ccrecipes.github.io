<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Scavenger: WebGL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.3.2/pixi.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        body { background-color: #000; color: white; font-family: 'Orbitron', sans-serif; overflow: hidden; user-select: none; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #game-container { position: relative; width: 100%; height: 100%; overflow: hidden; background: #050505; }
        canvas { display: block; width: 100%; height: 100%; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 60; }
        .crt-overlay { position: absolute; inset: 0; pointer-events: none; z-index: 50; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06)); background-size: 100% 2px, 3px 100%; box-shadow: inset 0 0 100px rgba(0,0,0,0.9); }
        .pointer-events-auto { pointer-events: auto; }
        .neon-text { text-shadow: 0 0 5px #0ff; }
        .btn-neon { background: rgba(0, 255, 255, 0.1); border: 2px solid #0ff; color: #0ff; box-shadow: 0 0 10px #0ff; transition: all 0.2s; cursor: pointer; }
        .btn-neon:hover { background: #0ff; color: #000; transform: scale(1.05); }
        .btn-neon:disabled { border-color: #333; color: #333; box-shadow: none; transform: none; cursor: not-allowed; background: rgba(0,0,0,0.5); }
        .heart-container { display: flex; gap: 4px; height: 24px; align-items: center; }
        .heart-icon { width: 24px; height: 24px; transition: transform 0.2s; }
        .heart-path { stroke: #ef4444; stroke-width: 2; fill: transparent; filter: drop-shadow(0 0 2px #ef4444); transition: all 0.2s; }
        .heart-active .heart-path { fill: #ef4444; filter: drop-shadow(0 0 8px #ef4444); }
        .progress-bar-bg { background: rgba(0,0,0,0.5); height: 6px; width: 100%; border: 1px solid #333; margin-top: 5px; }
        .progress-bar-fill { background: #0ff; height: 100%; width: 0%; box-shadow: 0 0 5px #0ff; transition: width 0.1s linear; }
        .tech-card { background: rgba(10, 10, 15, 0.9); border: 1px solid #333; position: relative; overflow: hidden; transition: all 0.2s; display: flex; flex-direction: column; }
        .tech-card:hover { border-color: var(--accent-color); box-shadow: 0 0 20px var(--accent-color-dim); transform: translateY(-5px); }
        .tech-icon-bg { position: absolute; top: -20px; right: -20px; font-size: 8rem; opacity: 0.1; transform: rotate(15deg); pointer-events: none; }
        .tech-pip { flex: 1; background: #444; transition: background 0.3s; }
        .tech-pip.active { background: var(--accent-color); box-shadow: 0 0 5px var(--accent-color); }
        .osu-logo { animation: pulse-logo 2s infinite ease-in-out; cursor: pointer; transition: transform 0.1s; }
        .osu-logo:hover { transform: scale(1.05); }
        .osu-logo:active { transform: scale(0.95); }
        @keyframes pulse-logo { 0% { box-shadow: 0 0 20px #0ff; } 50% { box-shadow: 0 0 50px #0ff, 0 0 100px cyan; } 100% { box-shadow: 0 0 20px #0ff; } }
        .track-item { height: 96px; border-right: 6px solid #444; transform: skewX(-15deg); transition: all 0.3s cubic-bezier(0.25, 1, 0.5, 1); cursor: pointer; padding-right: 50px; padding-left: 20px; display: flex; flex-direction: column; justify-content: center; align-items: flex-end; background-size: cover; background-position: center; background-repeat: no-repeat; box-shadow: 5px 5px 15px rgba(0,0,0,0.5); overflow: hidden; }
        .track-item:hover { transform: skewX(-15deg) translateX(-20px); border-right-color: #0ff; }
        .track-item.selected { border-right-color: #d946ef; transform: skewX(-15deg) translateX(-60px); width: Calc(100% + 40px); z-index: 10; box-shadow: 0 0 20px rgba(217, 70, 239, 0.3); }
        .track-content { transform: skewX(15deg); text-align: right; text-shadow: 0 2px 4px rgba(0,0,0,0.8); width: 100%; display: flex; flex-direction: column; align-items: flex-end; }
        @keyframes marquee-scroll { 0%, 20% { transform: translateX(0); } 50%, 70% { transform: translateX(var(--scroll-dist)); } 100% { transform: translateX(0); } }
        .marquee-container { overflow: hidden; white-space: nowrap; max-width: 25vw; text-align: right; display: block; position: relative; }
        .marquee-content { display: inline-block; }
        .animate-marquee { animation: marquee-scroll 8s linear infinite; }
        
        /* Special Cosmetic Animations */
        @keyframes hueRotate { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }
        .rainbow-anim { animation: hueRotate 3s infinite linear; }
        @keyframes pulseOpacity { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
        .pulse-anim { animation: pulseOpacity 2s infinite ease-in-out; }

        /* Flame Effect for EXTREME Difficulty */
        @keyframes flameText { 
            0% { text-shadow: 0 0 2px #FFFF00, 0 0 5px #FF0000; color: #FFFF00; border-color: #FF0000; } 
            50% { text-shadow: 0 0 5px #FFFF00, 0 0 10px #FF4500; color: #FFA500; border-color: #FF4500; }
            100% { text-shadow: 0 0 2px #FFFF00, 0 0 5px #FF0000; color: #FFFF00; border-color: #FF0000; } 
        }
        .flame-effect { animation: flameText 0.5s infinite; }
    </style>
</head>
<body>
    <div id="game-container">
        <div class="crt-overlay"></div>
        <div id="ui-layer" class="flex flex-col justify-between p-6">
            <div id="hud" class="hidden flex justify-between items-start w-full">
                <div class="w-1/3">
                    <div class="text-xs text-gray-400 mb-1">SYSTEM INTEGRITY</div>
                    <div id="livesContainer" class="heart-container mb-2"></div>
                    <div class="text-xl neon-text origin-left transition-transform duration-75" id="scoreContainer">SCORE: <span id="scoreVal">0</span></div>
                </div>
                <div id="songProgressContainer" class="w-1/3 px-4 opacity-0 transition-opacity">
                    <div class="text-xs text-center text-cyan-400">TRACK SYNCHRONIZATION</div>
                    <div class="progress-bar-bg"><div id="songProgressFill" class="progress-bar-fill"></div></div>
                </div>
                <div class="text-right w-1/3">
                    <div class="text-xs text-gray-400">SHARDS</div>
                    <div class="text-2xl text-yellow-400 font-bold">ðŸ’Ž <span id="currencyVal">0</span></div>
                </div>
            </div>

            <div id="mainMenu" class="absolute inset-0 pointer-events-auto overflow-hidden">
                <div class="absolute left-[10%] top-1/2 -translate-y-1/2 flex flex-col items-center z-20">
                    <div id="startBtn" class="osu-logo w-72 h-72 rounded-full border-[8px] border-white bg-black/90 flex items-center justify-center relative group shadow-2xl">
                        <div class="absolute inset-3 rounded-full border-2 border-cyan-500/50"></div>
                        <div class="text-center z-10">
                            <h1 class="text-4xl font-black text-white italic tracking-tighter leading-tight drop-shadow-lg">NEON<br><span class="text-5xl text-cyan-300">SCAVENGER</span></h1>
                            <div class="mt-3 text-sm text-cyan-400 font-bold tracking-[0.3em] opacity-80 group-hover:opacity-100 transition-opacity">CLICK TO START</div>
                        </div>
                    </div>
                    <div class="mt-16 flex gap-6">
                        <button id="shopBtn" class="btn-neon px-10 py-4 text-xl font-bold rounded skew-x-[-15deg] hover:bg-yellow-400/20 text-yellow-400 border-yellow-400 shadow-[0_0_15px_rgba(250,204,21,0.3)]">
                            <span class="inline-block skew-x-[15deg]">TECH LAB</span>
                        </button>
                        <button id="cosmeticsBtn" class="btn-neon px-10 py-4 text-xl font-bold rounded skew-x-[-15deg] hover:bg-purple-400/20 text-purple-400 border-purple-400 shadow-[0_0_15px_rgba(192,132,252,0.3)]">
                            <span class="inline-block skew-x-[15deg]">NANO-FABRICATOR</span>
                        </button>
                    </div>
                </div>

                <button id="changelogBtn" class="absolute bottom-4 left-4 text-[10px] text-gray-600 font-mono tracking-widest hover:text-green-400 hover:underline z-30 transition-colors cursor-pointer">
                    V.2.0.4 SYSTEM LOGS
                </button>

                <div class="absolute right-0 top-0 h-full w-[45%] bg-gradient-to-l from-black via-black/90 to-transparent flex flex-col pt-24 pb-12 overflow-hidden z-10 pointer-events-none">
                    <div class="text-right pr-12 mb-6 pointer-events-auto">
                        <h2 class="text-5xl font-black text-white italic drop-shadow-md">SELECT TRACK</h2>
                        <p class="text-sm text-cyan-400 font-mono tracking-widest mt-1">SYNC YOUR GAMEPLAY</p>
                    </div>
                    <div id="trackList" class="flex flex-col gap-3 w-full pl-32 pointer-events-auto overflow-y-auto pr-4" style="scrollbar-width: none;"></div>
                    <div class="mt-auto mr-[-40px] pr-16 pl-32 transform skew-x-[-15deg] bg-cyan-900/40 border-l-8 border-cyan-500 py-6 hover:translate-x-[-15px] transition-transform pointer-events-auto cursor-pointer relative group">
                        <div class="absolute inset-0 bg-gradient-to-r from-transparent to-cyan-500/10 group-hover:to-cyan-500/20 transition-all"></div>
                        <div class="transform skew-x-[15deg] text-right relative z-10">
                            <label class="block text-lg font-bold text-cyan-300 mb-1 cursor-pointer hover:text-white transition-colors">
                                ðŸ“‚ IMPORT CUSTOM AUDIO
                                <input type="file" id="musicUpload" accept="audio/*" class="hidden"/>
                            </label>
                            <div id="customFileName" class="text-xs text-gray-400 font-mono truncate">No file selected</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="changelogModal" class="hidden absolute inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-sm pointer-events-auto">
                <div class="relative w-3/4 max-w-2xl h-3/4 border border-green-900 bg-gray-900/95 flex flex-col p-2 shadow-[0_0_50px_rgba(20,83,45,0.2)]">
                    <div class="flex justify-between items-center bg-black/50 p-2 mb-2 border-b border-green-900/50">
                        <h3 class="text-green-400 font-mono text-sm tracking-widest">>> SYSTEM_CHANGELOG.TXT</h3>
                        <button id="closeChangelog" class="text-gray-500 hover:text-white text-xs font-mono">[X] CLOSE</button>
                    </div>
                    <div class="flex-1 bg-black p-4 overflow-y-auto custom-scrollbar border border-gray-800">
                        <pre id="changelogContent" class="text-xs md:text-sm font-mono text-green-500/80 whitespace-pre-wrap leading-relaxed"></pre>
                    </div>
                </div>
            </div>

            <div id="shopMenu" class="hidden absolute inset-0 bg-black/95 z-50 flex flex-col pointer-events-auto">
                <div class="p-8 border-b border-gray-800 flex justify-between items-end bg-gradient-to-b from-gray-900 to-black">
                    <div>
                        <h2 class="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500 italic drop-shadow-lg">TECH LAB</h2>
                        <p class="text-gray-400 font-mono mt-2 tracking-[0.5em] text-sm">AUGMENTATION STATION // V.2.0.4</p>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-gray-500 font-bold mb-1 tracking-widest">AVAILABLE CREDITS</div>
                        <div class="text-5xl text-yellow-400 font-mono drop-shadow-[0_0_10px_rgba(250,204,21,0.5)]">ðŸ’Ž <span id="shopCurrency">0</span></div>
                    </div>
                </div>
                <div class="flex-1 p-8 overflow-y-auto custom-scrollbar">
                    <div id="upgradeGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-7xl mx-auto"></div>
                </div>
                <div class="p-6 border-t border-gray-800 text-center bg-black">
                     <button id="closeShop" class="btn-neon px-16 py-4 text-xl font-bold rounded skew-x-[-10deg] hover:bg-white hover:text-black transition-colors">RETURN TO MENU</button>
                </div>
            </div>

            <div id="cosmeticsMenu" class="hidden absolute inset-0 bg-black/95 z-50 flex flex-col pointer-events-auto">
                <div class="p-8 border-b border-gray-800 flex justify-between items-end bg-gradient-to-b from-gray-900 to-black">
                    <div>
                        <h2 class="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500 italic drop-shadow-lg">NANO-FABRICATOR</h2>
                        <p class="text-gray-400 font-mono mt-2 tracking-[0.5em] text-sm">HULL MODIFICATION MATRIX</p>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-gray-500 font-bold mb-1 tracking-widest">AVAILABLE CREDITS</div>
                        <div class="text-5xl text-yellow-400 font-mono drop-shadow-[0_0_10px_rgba(250,204,21,0.5)]">ðŸ’Ž <span id="skinShopCurrency">0</span></div>
                    </div>
                </div>
                
                <div class="flex flex-1 overflow-hidden">
                    <div class="w-1/3 border-r border-gray-800 bg-gray-900/50 flex flex-col items-center justify-center p-8 relative overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-b from-purple-500/5 to-transparent pointer-events-none"></div>
                        <h3 class="text-cyan-400 font-mono tracking-widest text-sm absolute top-6 left-6">LIVE PREVIEW</h3>
                        
                        <div class="w-64 h-64 border border-gray-700 bg-black/50 rounded-lg flex items-center justify-center relative shadow-[0_0_30px_rgba(0,0,0,0.5)]">
                            <svg id="shipPreview" viewBox="-50 -50 100 100" class="w-48 h-48 drop-shadow-[0_0_15px_rgba(255,255,255,0.2)]" style="overflow: visible;">
                                <path id="previewCore" d="" stroke-width="2" />
                                <path id="previewGlow" d="" stroke-width="4" fill="none" class="blur-sm opacity-50" />
                            </svg>
                        </div>
                        <div class="mt-6 text-center">
                            <div id="previewName" class="text-2xl font-black text-white italic">MODEL NAME</div>
                            <div id="previewColor" class="text-sm font-mono text-gray-400">COLOR SCHEME</div>
                        </div>
                    </div>

                    <div class="w-2/3 flex flex-col overflow-hidden">
                        <div class="flex border-b border-gray-800">
                            <button id="tabModels" class="flex-1 py-4 font-bold tracking-widest bg-gray-900 text-white border-b-2 border-purple-500 transition-colors">CHASSIS MODELS</button>
                            <button id="tabColors" class="flex-1 py-4 font-bold tracking-widest bg-black text-gray-500 border-b-2 border-transparent hover:text-white transition-colors">COLOR PALETTES</button>
                        </div>
                        
                        <div id="modelsList" class="flex-1 overflow-y-auto p-8 grid grid-cols-2 gap-6 content-start custom-scrollbar">
                            </div>
                        <div id="colorsList" class="hidden flex-1 overflow-y-auto p-8 grid grid-cols-2 gap-6 content-start custom-scrollbar">
                            </div>
                    </div>
                </div>

                <div class="p-6 border-t border-gray-800 text-center bg-black">
                     <button id="closeCosmetics" class="btn-neon px-16 py-4 text-xl font-bold rounded skew-x-[-10deg] hover:bg-white hover:text-black transition-colors">RETURN TO MENU</button>
                </div>
            </div>

            <div id="gameOver" class="hidden absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm pointer-events-auto">
                <div class="relative max-w-lg w-full bg-gray-900/90 border-2 border-red-500 p-8 transform -skew-x-6 shadow-[0_0_50px_rgba(239,68,68,0.3)]">
                    <div class="transform skew-x-6 text-center">
                        <h2 class="text-6xl font-black text-red-500 mb-2 drop-shadow-[0_0_10px_rgba(239,68,68,0.8)]">SYSTEM FAILURE</h2>
                        <div class="h-1 w-full bg-red-900/50 mb-6"></div>
                        
                        <div class="mb-8">
                            <div class="text-xs text-red-300 tracking-[0.3em] mb-1">DATA SECURED</div>
                            <div class="text-4xl text-white font-mono font-bold">ðŸ’Ž <span id="finalShards">0</span></div>
                        </div>

                        <div class="flex flex-col gap-3">
                            <button id="retryBtn" class="btn-neon border-red-500 text-red-500 hover:bg-red-500 hover:text-black py-4 text-xl font-bold tracking-widest w-full">REBOOT SYSTEM</button>
                            <div class="flex gap-3">
                                <button id="failShopBtn" class="btn-neon flex-1 py-3 font-bold border-yellow-400 text-yellow-400 hover:bg-yellow-400 hover:text-black">TECH LAB</button>
                                <button id="failMenuBtn" class="btn-neon flex-1 py-3 font-bold border-gray-400 text-gray-400 hover:bg-gray-400 hover:text-black">MAIN MENU</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="gameSuccess" class="hidden absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm pointer-events-auto">
                <div class="relative max-w-lg w-full bg-gray-900/90 border-2 border-green-400 p-8 transform -skew-x-6 shadow-[0_0_50px_rgba(74,222,128,0.3)]">
                    <div class="transform skew-x-6 text-center">
                        <h2 class="text-6xl font-black text-green-400 mb-2 drop-shadow-[0_0_10px_rgba(74,222,128,0.8)]">MISSION COMPLETE</h2>
                        <div class="h-1 w-full bg-green-900/50 mb-6"></div>
                        
                        <div class="mb-8">
                            <div class="text-xs text-green-300 tracking-[0.3em] mb-1">TOTAL DATA SECURED</div>
                            <div class="text-4xl text-white font-mono font-bold">ðŸ’Ž <span id="successShards">0</span></div>
                        </div>

                        <div class="flex flex-col gap-3">
                            <button id="successShopBtn" class="btn-neon py-4 text-xl font-bold tracking-widest w-full border-yellow-400 text-yellow-400 hover:bg-yellow-400 hover:text-black">ACCESS TECH LAB</button>
                            <button id="successMenuBtn" class="btn-neon py-3 font-bold border-gray-400 text-gray-400 hover:bg-gray-400 hover:text-black w-full">RETURN TO MENU</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const container = document.getElementById('game-container');
        const app = new PIXI.Application({ resizeTo: container, backgroundAlpha: 0, antialias: true, resolution: window.devicePixelRatio || 1, autoDensity: true });
        container.appendChild(app.view);

        const gameContainer = new PIXI.Container();
        const glitchGraphics = new PIXI.Graphics();
        app.stage.addChild(gameContainer, glitchGraphics);

        const crtFrag = `precision mediump float; varying vec2 vTextureCoord; uniform sampler2D uSampler; void main(void) { vec2 uv = vTextureCoord; uv = uv * 2.0 - 1.0; vec2 offset = uv.yx / 5.0; uv = uv + uv * offset * offset; uv = uv * 0.5 + 0.5; if (uv.x < 0.0 || uv.x > 1.0 || uv.y < 0.0 || uv.y > 1.0) { gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0); } else { gl_FragColor = texture2D(uSampler, uv); } }`;
        app.stage.filters = [new PIXI.Filter(null, crtFrag)];

        const bgGraphics = new PIXI.Graphics();
        const sunGraphics = new PIXI.Graphics();
        const gridGraphics = new PIXI.Graphics();
        const glowContainer = new PIXI.Container();
        const coreContainer = new PIXI.Container();
        gameContainer.addChild(bgGraphics, sunGraphics, gridGraphics, glowContainer, coreContainer);

        const neonFilter = new PIXI.BlurFilter(8);
        const sunBlur = new PIXI.BlurFilter(20);
        sunGraphics.filters = [sunBlur];
        glowContainer.filters = [neonFilter];
        glowContainer.alpha = 0.8;

        let width = app.screen.width, height = app.screen.height, arenaApothem = 0;
        let arenaVertices = [], arenaWalls = [];

        function updateArenaGeometry() {
            width = app.screen.width; height = app.screen.height;
            arenaApothem = Math.min(width, height) * 0.65;
            gameContainer.x = width / 2; gameContainer.y = height / 2;
            arenaVertices = []; arenaWalls = [];
            
            const R = arenaApothem / Math.cos(Math.PI / 8);
            for(let i=0; i<8; i++) {
                const theta = (i * Math.PI / 4) + (Math.PI / 8);
                arenaVertices.push({x: Math.cos(theta) * R, y: Math.sin(theta) * R});
            }
            
            for(let i=0; i<8; i++) {
                const p1 = arenaVertices[i], p2 = arenaVertices[(i+1)%8];
                const mx = (p1.x + p2.x) / 2, my = (p1.y + p2.y) / 2, len = Math.hypot(mx, my);
                arenaWalls.push({ nx: mx / len, ny: my / len, dist: len });
            }
            drawBorder();
        }

        window.addEventListener('resize', updateArenaGeometry);

        // DATA CONFIG
        const modelsConfig = {
            'default': { name: "Mk.I SCAVENGER", cost: 0, path: "M 20 0 L -12 12 L -6 0 L -12 -12 Z" },
            'needle': { name: "CRIMSON REAPER", cost: 50000, path: "M 25 0 L -15 8 L -10 0 L -15 -8 Z" },
            'wing': { name: "MIDAS PROTOCOL", cost: 100000, path: "M 20 0 L -10 18 L -5 0 L -10 -18 Z" },
            'stealth': { name: "VOID PHANTOM", cost: 250000, path: "M 15 0 L -10 12 L 0 0 L -10 -12 Z" },
            'titan': { name: "TITAN VANGUARD", cost: 500000, path: "M 15 -8 L 25 0 L 15 8 L -10 14 L -5 0 L -10 -14 Z" },
            'seraph': { name: "CELESTIAL SERAPH", cost: 1000000, path: "M 30 0 L -5 8 L -20 22 L -10 4 L -20 0 L -10 -4 L -20 -22 L -5 -8 Z" }
        };

        const palettesConfig = {
            'default': { name: "SYSTEM CYAN", cost: 0, colors: { core: 0x000000, line: 0xFFFFFF, glow: 0x00FFFF, flame: 0x00FFFF } },
            'magma': { name: "MAGMA CORE", cost: 5000, colors: { core: 0x220000, line: 0xFF4400, glow: 0xFF0000, flame: 0xFFAA00 } },
            'midnight': { name: "MIDNIGHT RUN", cost: 5000, colors: { core: 0x000033, line: 0x4444FF, glow: 0x0000FF, flame: 0xCC00FF } },
            'neon': { name: "TOXIC NEON", cost: 10000, colors: { core: 0x002200, line: 0x00FF00, glow: 0x00FF00, flame: 0x00FF99 } },
            'orchid': { name: "NEON ORCHID", cost: 10000, colors: { core: 0x110022, line: 0xFF00FF, glow: 0xDDA0DD, flame: 0xFF00FF } },
            'royal': { name: "ROYAL GUARD", cost: 10000, colors: { core: 0x000022, line: 0xFFD700, glow: 0x4169E1, flame: 0xFFD700 } },
            'crimson': { name: "DANGER RED", cost: 15000, colors: { core: 0x220000, line: 0xFF0000, glow: 0xFF0000, flame: 0xFF4400 } },
            'arctic': { name: "ARCTIC OPS", cost: 15000, colors: { core: 0xEEFFFF, line: 0x00FFFF, glow: 0x0088FF, flame: 0x00FFFF } },
            'midas': { name: "LUXURY GOLD", cost: 20000, colors: { core: 0x221100, line: 0xFFD700, glow: 0xFFD700, flame: 0xFFFF00 } },
            'void': { name: "DEEP VOID", cost: 20000, colors: { core: 0x000000, line: 0x9900FF, glow: 0x5500AA, flame: 0xCC00FF } },
            'stealth': { name: "NIGHT OPS", cost: 20000, colors: { core: 0x111111, line: 0x333333, glow: 0xFF0000, flame: 0x550000 } },
            'spectral': { name: "SPECTRAL SHIFT", cost: 50000, colors: { core: 0x111111, line: 0xFFFFFF, glow: 0xFF00FF, flame: 0x00FFFF } },
            'holofoil': { name: "HOLOFOIL", cost: 100000, special: 'pulse', colors: { core: 0x000000, line: 0xFFFFFF, glow: 0xFFFFFF, flame: 0xFFFFFF } },
            'chroma': { name: "RGB OVERLOAD", cost: 500000, special: 'chroma', colors: { core: 0x000000, line: 0xFFFFFF, glow: 0xFFFFFF, flame: 0xFFFFFF } }
        };

        const defaultSave = { 
            currency: 0, 
            upgrades: { damage: 1, fireRate: 1, speed: 1, magnet: 1, homing: 0, multishot: 0 },
            ownedModels: ['default'],
            ownedPalettes: ['default'],
            equippedModel: 'default',
            equippedPalette: 'default'
        };
        let saveData = JSON.parse(localStorage.getItem('neonScavengerSave')) || defaultSave;
        
        // MIGRATION SAFEGUARD
        if (!saveData.ownedModels) saveData.ownedModels = ['default'];
        if (!saveData.ownedPalettes) saveData.ownedPalettes = ['default'];
        if (!saveData.equippedModel) saveData.equippedModel = 'default';
        if (!saveData.equippedPalette) saveData.equippedPalette = 'default';

        const saveGame = () => { localStorage.setItem('neonScavengerSave', JSON.stringify(saveData)); updateShop(); updateCosmetics(); };
        
        let gameState = { running: false, victory: false, score: 0, currency: 0, runCurrency: 0, spawnTimer: 0, timeAlive: 0, isDying: false, deathTimer: 0, timeScale: 1.0, screenShake: 0, mouse: { x: 0, y: 0 } };

        const entities = { player: null, bullets: [], enemies: [], particles: [], shockwaves: [], loot: [], borderCore: new PIXI.Graphics(), borderGlow: new PIXI.Graphics(), stars: [] };
        coreContainer.addChild(entities.borderCore); glowContainer.addChild(entities.borderGlow);

        const audio = { ctx: null, analyser: null, dataArray: null, element: new Audio(), setup: false, beatValue: 0, smoothedBins: new Array(120).fill(0) };
        const tracks = [
            { 
                id: "track3", 
                title: "Saving Light", 
                artist: "Wuthering Waves, Thena A, N2V, xTOx, VISION SOUND", 
                src: "./tracks/Saving_Light.mp3", 
                cover: "./covers/Saving_Light.jpg", 
                duration: "2:58",
                difficulty: "EASY",
                difficultyClass: "text-green-400 border-green-400"
            },
            { 
                id: "track1", 
                title: "I Really Want to Stay at Your House", 
                artist: "Rosa Walton", 
                src: "./tracks/Rosa_Walton_I_Really_Want_to_Stay_at_Your_House.mp3", 
                cover: "./covers/Rosa_Walton_I_Really_Want_to_Stay_at_Your_House.jpg", 
                duration: "4:11",
                difficulty: "MEDIUM",
                difficultyClass: "text-yellow-400 border-yellow-400"
            },
            { 
                id: "track2", 
                title: "Cyber City Lights", 
                artist: "Teamfight Tactics", 
                src: "./tracks/Cyber_City_Lights.mp3", 
                cover: "./covers/cybercity_lights.jpg", 
                duration: "4:21",
                difficulty: "HARD",
                difficultyClass: "text-red-500 border-red-500"
            },
            { 
                id: "track_spoiler", 
                title: "Spoiler", 
                artist: "Hyper", 
                src: "./tracks/Spoiler_Hyper.mp3", 
                cover: "./covers/Spoiler_Hyper.jpg", 
                duration: "4:31",
                difficulty: "HARD",
                difficultyClass: "text-red-500 border-red-500"
            },
            { 
                id: "track_fire", 
                title: "Through The Fire And Flames", 
                artist: "DragonForce", 
                src: "./tracks/Through_The_Fire_And_Flames.mp3", 
                cover: "./covers/Through_The_Fire_And_Flames.jpg", 
                duration: "7:19",
                difficulty: "EXTREME",
                difficultyClass: "flame-effect"
            }
        ];
        let selectedTrackIndex = 0;

        function renderTrackList() {
            const list = document.getElementById('trackList');
            list.innerHTML = '';
            tracks.forEach((track, idx) => {
                const div = document.createElement('div');
                div.className = `track-item ${idx === selectedTrackIndex ? 'selected' : ''}`;
                div.style.backgroundImage = idx === selectedTrackIndex ? `linear-gradient(90deg, rgba(0,0,0,0.6) 0%, rgba(217, 70, 239, 0.2) 100%), url('${track.cover}')` : `linear-gradient(to right, #000 0%, #000 30%, transparent 100%), url('${track.cover}')`;
                div.innerHTML = `<div class="track-content relative z-10"><div class="marquee-container" id="track-title-${idx}"><div class="marquee-content text-2xl font-black text-white leading-none uppercase drop-shadow-md">${track.title}</div></div><div class="flex justify-end gap-3 mt-1 items-baseline w-full"><span class="text-[10px] font-mono ${track.difficultyClass || 'text-gray-400 border-gray-400'} border px-1 rounded flex-shrink-0 tracking-wider">${track.difficulty || 'CUSTOM'}</span><span class="text-xs font-mono text-cyan-400 font-bold tracking-wider truncate max-w-[15vw]">${track.artist}</span><span class="text-[10px] font-mono text-gray-300 bg-black/50 px-1 rounded flex-shrink-0">${track.duration}</span></div></div>`;
                div.onclick = () => { if (selectedTrackIndex !== idx) { selectedTrackIndex = idx; if(track.id !== 'custom') { document.getElementById('musicUpload').value = ''; document.getElementById('customFileName').innerText = "No file selected"; } renderTrackList(); playPreview(idx); } };
                list.appendChild(div);
            });
            setTimeout(() => tracks.forEach((_, idx) => {
                const c = document.getElementById(`track-title-${idx}`), content = c?.querySelector('.marquee-content');
                if(c && content.scrollWidth > c.clientWidth) { content.style.setProperty('--scroll-dist', (c.clientWidth - content.scrollWidth - 10) + 'px'); content.classList.add('animate-marquee'); }
            }), 0);
        }
        
        const unlockAudio = () => { if (audio.ctx?.state === 'suspended') audio.ctx.resume(); if (audio.element.paused && audio.element.src) audio.element.play().catch(()=>{}); if (audio.ctx?.state === 'running') { document.removeEventListener('click', unlockAudio); document.removeEventListener('keydown', unlockAudio); } };
        document.addEventListener('click', unlockAudio); document.addEventListener('keydown', unlockAudio);

        renderTrackList();
        setTimeout(() => playPreview(0), 500);

        document.getElementById('musicUpload').onchange = (e) => {
            const f = e.target.files[0];
            if(f) {
                const newTrack = { 
                    id: 'custom', 
                    title: f.name.replace(/\.[^/.]+$/, ""), 
                    artist: "Custom Upload", 
                    src: URL.createObjectURL(f), 
                    cover: "https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=400&auto=format&fit=crop", 
                    duration: "Custom",
                    difficulty: "CUSTOM",
                    difficultyClass: "text-gray-400 border-gray-400"
                };
                const idx = tracks.findIndex(t => t.id === 'custom');
                idx !== -1 ? tracks[idx] = newTrack : tracks.push(newTrack);
                selectedTrackIndex = tracks.findIndex(t => t.id === 'custom');
                document.getElementById('customFileName').innerText = f.name;
                renderTrackList(); playPreview(selectedTrackIndex);
            }
        };

        function playPreview(index) {
            const track = tracks[index];
            if(!track?.src) return;
            if(!audio.ctx) { audio.ctx = new (window.AudioContext || window.webkitAudioContext)(); audio.analyser = audio.ctx.createAnalyser(); audio.analyser.fftSize = 2048; audio.dataArray = new Uint8Array(audio.analyser.frequencyBinCount); }
            if(!audio.setup) { audio.ctx.createMediaElementSource(audio.element).connect(audio.analyser); audio.analyser.connect(audio.ctx.destination); audio.setup = true; }
            if(audio.ctx.state === 'suspended') audio.ctx.resume();
            if (audio.element.src !== track.src) audio.element.src = track.src;
            audio.element.currentTime = 0; audio.element.volume = 0.5; audio.element.loop = true; audio.element.play().catch(()=>{});
        }

        class Player {
            constructor() {
                this.model = modelsConfig[saveData.equippedModel] || modelsConfig['default'];
                this.palette = palettesConfig[saveData.equippedPalette] || palettesConfig['default'];

                this.core = new PIXI.Graphics();
                this.core.lineStyle(2, this.palette.colors.line);
                this.core.beginFill(this.palette.colors.core);
                this.drawShape(this.core);
                this.core.endFill();
                
                this.glow = new PIXI.Graphics();
                this.glow.lineStyle(6, this.palette.colors.glow);
                this.drawShape(this.glow);

                this.flame = new PIXI.Graphics();
                this.core.addChild(this.flame);

                this.x = 0; this.y = 0; this.vx = 0; this.vy = 0; this.angle = 0; this.radius = 12; this.shooting = false;
                this.hue = 0; // For rainbow effect
                this.stats = { speed: 6 + (saveData.upgrades.speed * 0.5), lives: 3, cooldown: 0, maxCooldown: Math.max(5, 20 - (saveData.upgrades.fireRate * 2)) };
                coreContainer.addChild(this.core); glowContainer.addChild(this.glow);
            }

            drawShape(g) {
                // Parse the SVG Path string manually to PIXI commands
                // Simple parser for M and L commands
                const path = this.model.path.split(' ');
                let i = 0;
                while(i < path.length) {
                    const cmd = path[i++];
                    if(cmd === 'M') {
                        g.moveTo(parseFloat(path[i++]), parseFloat(path[i++]));
                    } else if(cmd === 'L') {
                        g.lineTo(parseFloat(path[i++]), parseFloat(path[i++]));
                    } else if(cmd === 'Z') {
                        g.closePath();
                    }
                }
            }

            update(dt) {
                if (gameState.isDying) return;
                
                // Color Cycling for Chroma Skin
                if (this.palette.special === 'chroma') {
                    this.hue += 0.5 * dt; 
                    if(this.hue > 360) this.hue = 0;
                    
                    // Simple HSL to RGB conversion for tint
                    const s = 100, l = 50;
                    const c = (1 - Math.abs(2 * l / 100 - 1)) * s / 100;
                    const x = c * (1 - Math.abs((this.hue / 60) % 2 - 1));
                    const m = l / 100 - c / 2;
                    let r = 0, g = 0, b = 0;
                    
                    if (0 <= this.hue && this.hue < 60) { r = c; g = x; b = 0; }
                    else if (60 <= this.hue && this.hue < 120) { r = x; g = c; b = 0; }
                    else if (120 <= this.hue && this.hue < 180) { r = 0; g = c; b = x; }
                    else if (180 <= this.hue && this.hue < 240) { r = 0; g = x; b = c; }
                    else if (240 <= this.hue && this.hue < 300) { r = x; g = 0; b = c; }
                    else if (300 <= this.hue && this.hue < 360) { r = c; g = 0; b = x; }
                    
                    const rgb = ((Math.round((r + m) * 255) << 16) + (Math.round((g + m) * 255) << 8) + Math.round((b + m) * 255));
                    
                    this.core.tint = rgb;
                    this.glow.tint = rgb;
                }

                let dx = 0, dy = 0;
                if (keys['w'] || keys['ArrowUp']) dy = -1; if (keys['s'] || keys['ArrowDown']) dy = 1;
                if (keys['a'] || keys['ArrowLeft']) dx = -1; if (keys['d'] || keys['ArrowRight']) dx = 1;
                if (dx !== 0 || dy !== 0) { const len = Math.hypot(dx, dy); dx/=len; dy/=len; }
                this.vx += dx * this.stats.speed * 0.1 * dt; this.vy += dy * this.stats.speed * 0.1 * dt;
                this.vx *= 0.96; this.vy *= 0.96; this.x += this.vx * dt; this.y += this.vy * dt;

                for(const wall of arenaWalls) {
                    const dist = this.x * wall.nx + this.y * wall.ny;
                    if (dist > wall.dist - this.radius) {
                        const overlap = dist - (wall.dist - this.radius);
                        this.x -= wall.nx * overlap; this.y -= wall.ny * overlap;
                        const dot = this.vx * wall.nx + this.vy * wall.ny;
                        this.vx -= 1.5 * dot * wall.nx; this.vy -= 1.5 * dot * wall.ny;
                        spawnParticles(this.x + wall.nx*10, this.y + wall.ny*10, this.palette.colors.glow, 3);
                    }
                }
                this.core.x = this.glow.x = this.x; this.core.y = this.glow.y = this.y;
                const local = gameContainer.toLocal(app.renderer.events.pointer.global);
                this.angle = Math.atan2(local.y - this.y, local.x - this.x);
                this.core.rotation = this.glow.rotation = this.angle;

                if (this.stats.cooldown > 0) this.stats.cooldown -= dt;
                if (this.shooting && this.stats.cooldown <= 0) {
                    const dmg = 10 + (saveData.upgrades.damage * 5), count = 1 + Math.min(2, saveData.upgrades.multishot || 0);
                    for(let i=0; i<count; i++) {
                        const angle = this.angle + (i - (count - 1) / 2) * 0.2;
                        entities.bullets.push(new Bullet(this.x, this.y, angle, dmg));
                    }
                    this.stats.cooldown = this.stats.maxCooldown;
                    this.vx -= Math.cos(this.angle)*0.2; this.vy -= Math.sin(this.angle)*0.2; gameState.screenShake += 2;
                }
                this.flame.clear();
                if (Math.abs(this.vx) > 0.1 || Math.abs(this.vy) > 0.1) {
                    this.flame.beginFill(this.palette.colors.flame); 
                    this.flame.moveTo(-14, -6); 
                    this.flame.lineTo(-24 - Math.random()*10, 0); 
                    this.flame.lineTo(-14, 6); 
                    this.flame.endFill();
                }
            }
            takeDamage(amt) {
                if (gameState.isDying) return;
                this.stats.lives--; gameState.timeAlive = Math.max(0, gameState.timeAlive - 15); gameState.score = Math.max(0, gameState.score - 500);
                updateHUD(); updateLivesUI(this.stats.lives); spawnParticles(this.x, this.y, this.palette.colors.glow, 8); gameState.screenShake = 15;
                if (this.stats.lives <= 0) startDeathSequence();
            }
            destroy() { coreContainer.removeChild(this.core); glowContainer.removeChild(this.glow); this.core.destroy(); this.glow.destroy(); }
        }

        class Bullet {
            constructor(x, y, angle, dmg) {
                this.x = x; this.y = y; this.vx = Math.cos(angle) * 12; this.vy = Math.sin(angle) * 12;
                this.life = 60; this.damage = dmg; this.radius = 4;
                this.core = new PIXI.Graphics(); this.core.beginFill(0x00FFFF); this.core.drawCircle(0,0,3); this.core.endFill();
                this.glow = new PIXI.Graphics(); this.glow.beginFill(0x00FFFF, 0.8); this.glow.drawCircle(0,0,8); this.glow.endFill();
                this.core.x = this.glow.x = x; this.core.y = this.glow.y = y;
                coreContainer.addChild(this.core); glowContainer.addChild(this.glow);
            }
            update(dt) {
                const homingLvl = saveData.upgrades.homing || 0;
                if (homingLvl > 0) {
                    let closest = null, minDist = 60 + (homingLvl * 20);
                    entities.enemies.forEach(e => { const d = Math.hypot(e.x - this.x, e.y - this.y); if(d < minDist) { minDist = d; closest = e; }});
                    if (closest) {
                        const desired = Math.atan2(closest.y - this.y, closest.x - this.x);
                        let curr = Math.atan2(this.vy, this.vx), diff = desired - curr;
                        while (diff <= -Math.PI) diff += Math.PI * 2; while (diff > Math.PI) diff -= Math.PI * 2;
                        curr += Math.sign(diff) * Math.min(Math.abs(diff), 0.05 * homingLvl * dt);
                        this.vx = Math.cos(curr)*12; this.vy = Math.sin(curr)*12;
                    }
                }
                this.x += this.vx * dt; this.y += this.vy * dt; this.life -= dt;
                this.core.x = this.glow.x = this.x; this.core.y = this.glow.y = this.y;
                return this.life <= 0;
            }
            destroy() { coreContainer.removeChild(this.core); glowContainer.removeChild(this.glow); this.core.destroy(); this.glow.destroy(); }
        }

        class Enemy {
            constructor() {
                const angle = Math.random() * Math.PI * 2, r = arenaApothem + 50;
                this.x = Math.cos(angle) * r; this.y = Math.sin(angle) * r;
                const roll = Math.random();
                this.type = roll < 0.6 ? 0 : (roll < 0.85 ? 1 : 2);
                this.core = new PIXI.Graphics(); this.glow = new PIXI.Graphics(); this.vx = 0; this.vy = 0;
                if (this.type === 0) { this.speed = 2+Math.random(); this.hp = 20+(gameState.timeAlive*0.3); this.color = 0xF43F5E; this.radius = 12; this.value = 1; this.scoreValue = 25; }
                else if (this.type === 1) { this.speed = 1; this.hp = 60+(gameState.timeAlive*0.8); this.color = 0xA855F7; this.radius = 20; this.value = 5; this.scoreValue = 100; }
                else { this.speed = 0; this.hp = 30+(gameState.timeAlive*0.5); this.color = 0x22C55E; this.radius = 15; this.value = 3; this.vx = -Math.cos(angle)*3; this.vy = -Math.sin(angle)*3; this.time = 0; this.scoreValue = 60; }
                this.draw(this.core, 2, 1.0, false); this.draw(this.glow, 6, 0.8, true);
                this.core.x = this.glow.x = this.x; this.core.y = this.glow.y = this.y;
                coreContainer.addChild(this.core); glowContainer.addChild(this.glow);
            }
            draw(g, th, a, glow) {
                g.lineStyle(th, this.color, a);
                if (this.type === 0) g.drawRect(-12,-12,24,24);
                else if (this.type === 1) g.drawCircle(0,0,20);
                else { if(!glow) g.beginFill(this.color); g.drawRect(-10,-10,20,20); if(!glow) g.endFill(); }
            }
            update(dt) {
                if (this.type === 2) {
                    this.x += this.vx * dt; this.y += this.vy * dt; this.time += 0.05 * dt;
                    this.x += Math.sin(this.time); this.y += Math.cos(this.time);
                    if (Math.hypot(this.x, this.y) > arenaApothem + 200) return true;
                } else if (entities.player) {
                    const ang = Math.atan2(entities.player.y - this.y, entities.player.x - this.x);
                    this.x += Math.cos(ang) * this.speed * dt; this.y += Math.sin(ang) * this.speed * dt;
                }
                const rot = 0.05 * dt; this.core.rotation += rot; this.glow.rotation += rot;
                this.core.x = this.glow.x = this.x; this.core.y = this.glow.y = this.y;
                
                if (!gameState.isDying && entities.player) {
                    if (Math.hypot(this.x - entities.player.x, this.y - entities.player.y) < this.radius + entities.player.radius) {
                        entities.player.takeDamage(10);
                        if (!entities.player) return false;
                        if (this.type !== 1) { this.hp = 0; spawnParticles(this.x, this.y, this.color, 10); spawnShockwave(this.x, this.y, this.color); }
                        else { this.hp -= 20; const a = Math.atan2(entities.player.y - this.y, entities.player.x - this.x); entities.player.vx += Math.cos(a)*10; entities.player.vy += Math.sin(a)*10; }
                    }
                }
                return this.hp <= 0;
            }
            destroy() { coreContainer.removeChild(this.core); glowContainer.removeChild(this.glow); this.core.destroy(); this.glow.destroy(); }
        }

        class Loot {
            constructor(x, y, val) {
                this.x = x; this.y = y; this.val = val; this.vx = (Math.random()-0.5)*2; this.vy = (Math.random()-0.5)*2;
                this.core = new PIXI.Graphics(); this.glow = new PIXI.Graphics();
                [this.core, this.glow].forEach((g, i) => { g.beginFill(0xFBBF24, i ? 0.8 : 1); g.drawRect(-3,-3,6,6); g.endFill(); });
                this.glow.scale.set(1.8); this.core.x = this.glow.x = x; this.core.y = this.glow.y = y;
                coreContainer.addChild(this.core); glowContainer.addChild(this.glow);
            }
            update(dt) {
                if (!entities.player) return false;
                const d = Math.hypot(this.x - entities.player.x, this.y - entities.player.y);
                if (d < 100 + (saveData.upgrades.magnet * 30) && !gameState.isDying) {
                    const ang = Math.atan2(entities.player.y - this.y, entities.player.x - this.x), spd = 8 + (500/d);
                    this.x += Math.cos(ang) * spd * dt; this.y += Math.sin(ang) * spd * dt;
                } else {
                    this.x += this.vx * dt; this.y += this.vy * dt; this.vx *= 0.98; this.vy *= 0.98;
                }
                const rot = 0.1 * dt; this.core.rotation += rot; this.glow.rotation += rot;
                this.core.x = this.glow.x = this.x; this.core.y = this.glow.y = this.y;
                if (d < 15 && !gameState.isDying) { gameState.runCurrency += this.val; updateHUD(); return true; }
                return false;
            }
            destroy() { coreContainer.removeChild(this.core); glowContainer.removeChild(this.glow); this.core.destroy(); this.glow.destroy(); }
        }

        class Particle {
            constructor(x, y, color, speed) {
                this.core = new PIXI.Graphics(); this.glow = new PIXI.Graphics();
                this.core.beginFill(color); this.core.drawCircle(0,0,2); this.core.endFill();
                this.glow.beginFill(color); this.glow.drawCircle(0,0,5); this.glow.endFill();
                this.x = x; this.y = y; this.core.x = this.glow.x = x; this.core.y = this.glow.y = y;
                const a = Math.random() * Math.PI * 2, s = Math.random() * speed;
                this.vx = Math.cos(a) * s; this.vy = Math.sin(a) * s; this.life = 1.0;
                coreContainer.addChild(this.core); glowContainer.addChild(this.glow);
            }
            update(dt) {
                this.x += this.vx * dt; this.y += this.vy * dt; this.life -= 0.03 * dt; this.vx *= 0.95; this.vy *= 0.95;
                this.core.x = this.glow.x = this.x; this.core.y = this.glow.y = this.y; this.core.alpha = this.glow.alpha = this.life;
                return this.life <= 0;
            }
            destroy() { coreContainer.removeChild(this.core); glowContainer.removeChild(this.glow); this.core.destroy(); this.glow.destroy(); }
        }

        class Shockwave {
            constructor(x, y, color) { this.g = new PIXI.Graphics(); this.x = x; this.y = y; this.color = color; this.radius = 1; this.life = 1.0; this.g.x = x; this.g.y = y; glowContainer.addChild(this.g); }
            update(dt) {
                this.radius += 8 * dt; this.life -= 0.05 * dt;
                this.g.clear(); this.g.lineStyle(4 * this.life, this.color, this.life); this.g.drawCircle(0,0, this.radius);
                return this.life <= 0;
            }
            destroy() { glowContainer.removeChild(this.g); this.g.destroy(); }
        }
        
        class Star {
            constructor() {
                this.x = (Math.random() - 0.5) * width * 4;
                this.y = (Math.random() - 0.5) * height * 4;
                this.size = Math.random() * 2 + 0.5;
                this.alpha = Math.random() * 0.5 + 0.2;
                this.twinkleSpeed = Math.random() * 0.05 + 0.01;
                this.angle = Math.random() * Math.PI * 2;
            }
            update(dt) {
                this.angle += this.twinkleSpeed * dt;
                return this.alpha + Math.sin(this.angle) * 0.2; // Return current alpha for drawing
            }
        }

        const spawnParticles = (x, y, c, n) => { for(let i=0; i<n; i++) entities.particles.push(new Particle(x, y, c, 8)); };
        const spawnShockwave = (x, y, c) => entities.shockwaves.push(new Shockwave(x, y, c));

        function drawBorder() {
            entities.borderCore.clear(); entities.borderGlow.clear();
            const draw = (g) => {
                g.moveTo(arenaVertices[0].x, arenaVertices[0].y);
                for(let i=1; i<arenaVertices.length; i++) g.lineTo(arenaVertices[i].x, arenaVertices[i].y);
                g.lineTo(arenaVertices[0].x, arenaVertices[0].y);
            };
            entities.borderGlow.lineStyle(15 + (audio.beatValue * 25), 0xD946EF, 0.6); draw(entities.borderGlow);
            entities.borderCore.lineStyle(4, 0xD946EF, 1.0); draw(entities.borderCore);
        }

        function updateLivesUI(lives) {
            const c = document.getElementById('livesContainer'); c.innerHTML = '';
            for(let i=0; i<3; i++) c.innerHTML += `<div class="heart-icon ${i < lives ? 'heart-active' : ''}"><svg viewBox="0 0 24 24" class="w-full h-full drop-shadow-md"><polygon points="12,21 2,10 5,3 12,7 19,3 22,10" class="heart-path"/></svg></div>`;
        }
        function updateHUD() { document.getElementById('scoreVal').innerText = gameState.score; document.getElementById('currencyVal').innerText = (saveData.currency + gameState.runCurrency); }

        function startAudio() {
            if(!audio.ctx) { audio.ctx = new (window.AudioContext || window.webkitAudioContext)(); audio.analyser = audio.ctx.createAnalyser(); audio.analyser.fftSize = 2048; audio.dataArray = new Uint8Array(audio.analyser.frequencyBinCount); }
            const t = tracks[selectedTrackIndex];
            if(t?.src) {
                audio.element.src = t.src;
                if(!audio.setup) { audio.ctx.createMediaElementSource(audio.element).connect(audio.analyser); audio.analyser.connect(audio.ctx.destination); audio.setup = true; }
                if(audio.ctx.state === 'suspended') audio.ctx.resume();
                audio.element.currentTime = 0; audio.element.playbackRate = 1; audio.element.volume = 1; audio.element.loop = false; audio.element.play();
                document.getElementById('songProgressContainer').classList.remove('opacity-0');
            } else document.getElementById('songProgressContainer').classList.add('opacity-0');
        }

        function analyzeAudio() {
            if(audio.element.duration) {
                const p = (audio.element.currentTime / audio.element.duration) * 100;
                document.getElementById('songProgressFill').style.width = p + '%';
                if((audio.element.ended || audio.element.currentTime >= audio.element.duration) && gameState.running && !gameState.victory) winGame();
            }
            if(!audio.ctx || audio.element.paused) { audio.beatValue *= 0.5; return; }
            audio.analyser.getByteFrequencyData(audio.dataArray);
            let sum = 0; for(let i=2; i<6; i++) sum += audio.dataArray[i];
            const norm = Math.pow((sum / 4) / 255, 6); // Reduced from 12 to 6 for better sensitivity
            audio.beatValue = norm > audio.beatValue ? norm : audio.beatValue * 0.4;
            document.getElementById('scoreContainer').style.transform = `scale(${1 + audio.beatValue * 0.2})`;
        }

        app.ticker.add((delta) => {
            if(gameState.victory) {
                analyzeAudio(); drawBorder();
                entities.particles = entities.particles.filter(p => !p.update(delta) || (p.destroy(), false));
                entities.shockwaves = entities.shockwaves.filter(s => !s.update(delta) || (s.destroy(), false));
                return;
            }
            if (!gameState.running) return;
            const dt = delta * gameState.timeScale;
            analyzeAudio();

            // --- SYNTHWAVE BACKGROUND ---
            bgGraphics.clear(); 
            sunGraphics.clear();
            // Deep Void Background (Dark Purple)
            bgGraphics.beginFill(0x090011); 
            bgGraphics.drawRect(-width*2, -height*2, width*4, height*4); 
            bgGraphics.endFill();

            // Draw Stars
            entities.stars.forEach(s => {
                const alpha = s.update(dt);
                bgGraphics.beginFill(0xFFFFFF, alpha);
                bgGraphics.drawCircle(s.x, s.y, s.size);
                bgGraphics.endFill();
            });

            // Retro Central Sun / Audio Visualizer
            const baseRadius = arenaApothem * 0.4;
            const numBins = 120; // Number of points in the sun visualizer
            const maxAmp = 100; // Max visualizer height
            
            // Outer Glow (Static + Beat Pulse) - Reduced Opacity
            sunGraphics.beginFill(0xFF00FF, 0.02); 
            sunGraphics.drawCircle(0, 0, baseRadius + 80 + (audio.beatValue * 20));
            sunGraphics.endFill();

            // Main Sun Visualizer - Reduced Opacity
            sunGraphics.beginFill(0xFF00FF, 0.08);
            const points = [];
            
            // Loop to create polygon points for the visualizer
            for (let i = 0; i < numBins; i++) {
                // Angle for this point (Start at top -PI/2)
                const angle = (i / numBins) * Math.PI * 2 - (Math.PI/2);
                
                // Non-mirrored Frequency Mapping
                // Map around the circle using frequencies 0-60 (Low to Mid-High)
                // +2 offset to skip DC/super-sub-bass which can be static
                const dataIdx = Math.floor((i / numBins) * 60) + 2;
                
                // Get audio data (with safety check)
                const targetVal = (audio.dataArray && audio.dataArray.length > dataIdx) ? audio.dataArray[dataIdx] : 0; 
                
                // Smoothing logic: interpolate current value towards target
                // If audio.smoothedBins isn't initialized yet (safety), treat as 0
                if (!audio.smoothedBins) audio.smoothedBins = new Array(numBins).fill(0);
                
                // Lerp factor 0.03 for very slow, smooth transitions ("mist-like")
                audio.smoothedBins[i] += (targetVal - audio.smoothedBins[i]) * 0.03; 
                
                const val = audio.smoothedBins[i];

                // Radius = Base + Frequency Amplitude + Beat Pulse (Dampened beat pulse)
                const r = baseRadius + (val / 255) * maxAmp + (audio.beatValue * 10);
                points.push(Math.cos(angle) * r, Math.sin(angle) * r);
            }
            
            // Close the polygon loop and draw
            if (points.length > 0) {
                 points.push(points[0], points[1]);
                 sunGraphics.drawPolygon(points);
            }
            sunGraphics.endFill();

            // --- NEON GRID ---
            gridGraphics.clear(); 
            // Cyan Grid Lines, pulsing with beat
            const gridAlpha = 0.1 + audio.beatValue * 0.1; // Reduced from 0.15 + * 0.25
            const gridThick = 1 + (audio.beatValue * 1.5); // Reduced from 2 + * 3
            gridGraphics.lineStyle(gridThick, 0x00FFFF, gridAlpha);
            
            // Draw grid in arena bounds (expanded)
            const range = arenaApothem + 500;
            const gridSize = 60;
            for(let x = -range; x <= range; x += gridSize) { gridGraphics.moveTo(x, -range); gridGraphics.lineTo(x, range); }
            for(let y = -range; y <= range; y += gridSize) { gridGraphics.moveTo(-range, y); gridGraphics.lineTo(range, y); }

            neonFilter.blur = 10 + (audio.beatValue * 15); glowContainer.alpha = 0.6 + (audio.beatValue * 0.4);

            if (gameState.isDying) {
                gameState.timeScale = Math.max(0, gameState.timeScale - 0.005 * delta); gameState.deathTimer -= delta;
                if(audio.element.playbackRate > 0.1) audio.element.playbackRate *= 0.99;
                if(audio.element.volume > 0.05) audio.element.volume *= 0.98; else audio.element.pause();
                gameContainer.scale.x += (0.001 * delta); gameContainer.scale.y = gameContainer.scale.x;
                if (gameState.deathTimer <= 0) endGame();
            } else {
                gameState.timeScale = 1.0;
                const targetZoom = 1.0 + (audio.beatValue * 0.05);
                gameContainer.scale.x += (targetZoom - gameContainer.scale.x) * 0.1; gameContainer.scale.y = gameContainer.scale.x;
            }

            if(entities.player || gameState.isDying) {
                let tx = width/2, ty = height/2;
                if (entities.player) { tx += entities.player.x * -0.35; ty += entities.player.y * -0.35; }
                gameContainer.x += (tx - gameContainer.x) * 0.1 + (Math.random() - 0.5) * gameState.screenShake;
                gameContainer.y += (ty - gameContainer.y) * 0.1 + (Math.random() - 0.5) * gameState.screenShake;
            }
            if(gameState.screenShake > 0) gameState.screenShake *= 0.85;

            drawBorder();

            glitchGraphics.clear();
            if(gameState.isDying && Math.random() > 0.7) {
                glitchGraphics.beginFill(Math.random() > 0.5 ? 0x00FFFF : 0xFF00FF, 0.3);
                glitchGraphics.drawRect(Math.random()*width, Math.random()*height, Math.random()*width, Math.random()*50);
            }

            if (!gameState.isDying) {
                gameState.timeAlive += dt / 60; gameState.spawnTimer += dt * (1 + audio.beatValue * 5.0);
                if (gameState.spawnTimer > Math.max(35, 110 - (gameState.timeAlive * 0.4)) && entities.enemies.length < 5 + (gameState.timeAlive / 15)) {
                    entities.enemies.push(new Enemy()); gameState.spawnTimer = 0;
                }
            }

            if (entities.player) entities.player.update(dt);
            
            entities.bullets = entities.bullets.filter(b => {
                if(b.update(dt)) { b.destroy(); return false; }
                for (let j = entities.enemies.length - 1; j >= 0; j--) {
                    const e = entities.enemies[j];
                    if (Math.hypot(b.x - e.x, b.y - e.y) < b.radius + e.radius) {
                        e.hp -= b.damage; spawnParticles(e.x, e.y, 0x00FFFF, 3); gameState.screenShake = 3;
                        b.destroy();
                        if (e.hp <= 0) {
                            if(!gameState.isDying) { gameState.score += e.scoreValue || 100; updateHUD(); for(let k=0; k<Math.ceil(Math.random()*3); k++) entities.loot.push(new Loot(e.x, e.y, e.value)); }
                            spawnParticles(e.x, e.y, e.color, 15); spawnShockwave(e.x, e.y, e.color); gameState.screenShake = 15; e.destroy(); entities.enemies.splice(j, 1);
                        }
                        return false; 
                    }
                }
                return true;
            });
            entities.enemies = entities.enemies.filter(e => !e.update(dt) || (e.destroy(), false));
            entities.loot = entities.loot.filter(l => !l.update(dt) || (l.destroy(), false));
            entities.particles = entities.particles.filter(p => !p.update(dt) || (p.destroy(), false));
            entities.shockwaves = entities.shockwaves.filter(s => !s.update(dt) || (s.destroy(), false));
        });

        const keys = {};
        window.onkeydown = e => keys[e.key] = true; window.onkeyup = e => keys[e.key] = false;
        window.onmousedown = () => { if(entities.player) entities.player.shooting = true; };
        window.onmouseup = () => { if(entities.player) entities.player.shooting = false; };

        function startGame() {
            if(entities.player) entities.player.destroy();
            [...entities.bullets, ...entities.enemies, ...entities.loot, ...entities.particles, ...entities.shockwaves].forEach(e => e.destroy());
            entities.bullets = []; entities.enemies = []; entities.loot = []; entities.particles = []; entities.shockwaves = []; entities.stars = [];
            
            // Generate Stars
            for(let i=0; i<150; i++) entities.stars.push(new Star());

            Object.assign(gameState, { score: 0, runCurrency: 0, timeAlive: 0, isDying: false, victory: false, timeScale: 1.0, running: true });
            entities.player = new Player(); updateArenaGeometry(); updateHUD(); updateLivesUI(3); startAudio();
            ['mainMenu', 'gameOver', 'gameSuccess', 'shopMenu', 'cosmeticsMenu', 'changelogModal'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('hud').classList.remove('hidden');
        }

        function startDeathSequence() {
            gameState.isDying = true; gameState.deathTimer = 300; gameState.screenShake = 30;
            spawnParticles(entities.player.x, entities.player.y, entities.player.palette.colors.glow, 30); spawnShockwave(entities.player.x, entities.player.y, entities.player.palette.colors.glow);
            entities.player.destroy(); entities.player = null;
        }

        function endGame() {
            gameState.running = false; saveData.currency += gameState.runCurrency; saveGame();
            document.getElementById('finalShards').innerText = gameState.runCurrency;
            document.getElementById('hud').classList.add('hidden'); document.getElementById('gameOver').classList.remove('hidden');
        }

        function winGame() {
            gameState.victory = true; stopAudio();
            entities.enemies.forEach(e => { spawnParticles(e.x, e.y, e.color, 15); spawnShockwave(e.x, e.y, e.color); e.destroy(); });
            entities.enemies = [];
            setTimeout(() => {
                gameState.running = false; gameState.runCurrency += 500; saveData.currency += gameState.runCurrency; saveGame();
                document.getElementById('successShards').innerText = gameState.runCurrency + " (+500 BONUS)";
                document.getElementById('hud').classList.add('hidden'); document.getElementById('gameSuccess').classList.remove('hidden');
            }, 2000);
        }
        function stopAudio() { if(audio.element) { audio.element.pause(); audio.element.currentTime = 0; } }

        const upgradeConfig = {
            damage: { name: "PLASMA OUTPUT", desc: "Increase Projectile Damage", base: 150, color: "cyan", icon: "ðŸ’¥" },
            fireRate: { name: "CYCLER SPEED", desc: "Increase Fire Rate", base: 200, color: "green", icon: "âš¡" },
            speed: { name: "THRUSTERS", desc: "Increase Movement Speed", base: 100, color: "purple", icon: "ðŸš€" },
            magnet: { name: "VACUUM FIELD", desc: "Increase Pickup Range", base: 100, color: "pink", icon: "ðŸ§²" },
            homing: { name: "HOMING SYSTEM", desc: "Projectiles Seek Enemies", base: 300, color: "orange", icon: "ðŸŽ¯" },
            multishot: { name: "SPLIT BARREL", desc: "Fire Additional Projectiles", base: 500, color: "blue", icon: "ðŸ’ " }
        };

        function updateShop() {
            document.getElementById('shopCurrency').innerText = document.getElementById('currencyVal').innerText = saveData.currency;
            const grid = document.getElementById('upgradeGrid'); grid.innerHTML = '';
            const colors = { cyan: 'text-cyan-400 border-cyan-400 shadow-[0_0_10px_cyan]', green: 'text-green-400 border-green-400 shadow-[0_0_10px_lime]', purple: 'text-purple-400 border-purple-400 shadow-[0_0_10px_purple]', pink: 'text-pink-400 border-pink-400 shadow-[0_0_10px_pink]', orange: 'text-orange-400 border-orange-400 shadow-[0_0_10px_orange]', blue: 'text-blue-400 border-blue-400 shadow-[0_0_10px_blue]' };
            
            Object.keys(upgradeConfig).forEach(type => {
                const conf = upgradeConfig[type], lvl = saveData.upgrades[type] || 0;
                let cost = conf.base * Math.pow(1.5, lvl); if(type === 'multishot') cost = 2000 * Math.pow(2.5, lvl);
                cost = cost < 100 ? Math.round(cost/5)*5 : (cost < 1000 ? Math.round(cost/25)*25 : Math.round(cost/50)*50);
                const isMaxed = (type === 'multishot' && lvl >= 2) || lvl >= 10;
                
                const div = document.createElement('div');
                div.className = `tech-card p-6 rounded-lg ${colors[conf.color]} border`; div.style.setProperty('--accent-color', conf.color);
                let pips = ''; for(let i=0; i<((type==='multishot')?2:10); i++) pips += `<div class="tech-pip ${i < lvl ? 'active' : ''} h-1 flex-1 mx-[1px]"></div>`;
                
                div.innerHTML = `<div class="tech-icon-bg">${conf.icon}</div><div class="relative z-10 flex flex-col h-full"><div class="flex justify-between items-start mb-2"><h3 class="text-2xl font-black italic tracking-tighter">${conf.name}</h3><div class="text-4xl filter drop-shadow-md">${conf.icon}</div></div><p class="text-xs text-gray-400 font-mono mb-4 h-8">${conf.desc}</p><div class="mt-auto"><div class="flex justify-between items-end mb-2 font-mono"><span class="text-xs text-gray-500">LVL ${lvl}</span><span class="${isMaxed ? 'text-gray-500' : 'text-yellow-400'} font-bold text-xl">${isMaxed ? 'MAXED' : 'ðŸ’Ž ' + cost}</span></div><div class="flex w-full bg-gray-900 h-2 mb-4 rounded overflow-hidden">${pips}</div><button class="btn-neon w-full py-2 font-bold text-sm tracking-widest ${isMaxed ? 'opacity-50 cursor-not-allowed' : ''}" ${isMaxed ? 'disabled' : ''}>${isMaxed ? 'MAXIMUM LEVEL' : 'INSTALL UPGRADE'}</button></div></div>`;
                const btn = div.querySelector('button');
                if(!isMaxed && saveData.currency >= cost) { btn.onclick = () => { saveData.currency -= cost; saveData.upgrades[type] = (saveData.upgrades[type]||0) + 1; saveGame(); }; }
                else if(!isMaxed) { btn.disabled = true; btn.innerText = "INSUFFICIENT FUNDS"; btn.classList.add('opacity-50'); }
                grid.appendChild(div);
            });
        }

        // Cosmetics Logic
        let cosmeticsTab = 'models'; 
        let previewModel = null;
        let previewPalette = null;

        function updateCosmetics() {
            document.getElementById('skinShopCurrency').innerText = saveData.currency;
            
            // Sync preview state with current selection if not set
            if(!previewModel) previewModel = saveData.equippedModel;
            if(!previewPalette) previewPalette = saveData.equippedPalette;

            // Update Preview
            const m = modelsConfig[previewModel] || modelsConfig['default'];
            const p = palettesConfig[previewPalette] || palettesConfig['default'];
            
            const corePath = document.getElementById('previewCore');
            const glowPath = document.getElementById('previewGlow');
            const shipPreview = document.getElementById('shipPreview');
            
            // Hex helper
            const hex = (h) => '#' + h.toString(16).padStart(6, '0');
            
            let coreColor = hex(p.colors.core);
            let lineColor = hex(p.colors.line);
            let glowColor = hex(p.colors.glow);

            if (p.special === 'chroma') {
                // For previewing chroma on white base, we need a saturated base color for hue-rotate to work
                if (p.colors.line === 0xFFFFFF) lineColor = '#FF0000';
                if (p.colors.glow === 0xFFFFFF) glowColor = '#FF0000';
            }

            corePath.setAttribute('d', m.path);
            corePath.setAttribute('fill', coreColor);
            corePath.setAttribute('stroke', lineColor);
            
            glowPath.setAttribute('d', m.path);
            glowPath.setAttribute('stroke', glowColor);
            
            // Handle CSS Animations for Preview
            glowPath.classList.remove('rainbow-anim', 'pulse-anim');
            corePath.classList.remove('rainbow-anim', 'pulse-anim');
            shipPreview.style.filter = ''; // Reset

            if (p.special === 'chroma') {
                glowPath.classList.add('rainbow-anim');
                corePath.classList.add('rainbow-anim'); // Apply to core as well if white
                // For SVG preview, using CSS filter is easiest
                shipPreview.style.filter = 'hue-rotate(0deg)';
                shipPreview.classList.add('rainbow-anim');
            } else if (p.special === 'pulse') {
                glowPath.classList.add('pulse-anim');
            } else {
                shipPreview.classList.remove('rainbow-anim');
            }
            
            document.getElementById('previewName').innerText = m.name;
            document.getElementById('previewColor').innerText = p.name;
            document.getElementById('previewColor').style.color = hex(p.colors.glow);

            // Toggle Lists
            const modelsList = document.getElementById('modelsList');
            const colorsList = document.getElementById('colorsList');
            const tabModels = document.getElementById('tabModels');
            const tabColors = document.getElementById('tabColors');

            if (cosmeticsTab === 'models') {
                modelsList.classList.remove('hidden'); modelsList.classList.add('grid');
                colorsList.classList.add('hidden'); colorsList.classList.remove('grid');
                tabModels.classList.add('border-purple-500', 'text-white', 'bg-gray-900'); tabModels.classList.remove('border-transparent', 'text-gray-500', 'bg-black');
                tabColors.classList.remove('border-purple-500', 'text-white', 'bg-gray-900'); tabColors.classList.add('border-transparent', 'text-gray-500', 'bg-black');
                renderModelsList(modelsList);
            } else {
                modelsList.classList.add('hidden'); modelsList.classList.remove('grid');
                colorsList.classList.remove('hidden'); colorsList.classList.add('grid');
                tabColors.classList.add('border-purple-500', 'text-white', 'bg-gray-900'); tabColors.classList.remove('border-transparent', 'text-gray-500', 'bg-black');
                tabModels.classList.remove('border-purple-500', 'text-white', 'bg-gray-900'); tabModels.classList.add('border-transparent', 'text-gray-500', 'bg-black');
                renderColorsList(colorsList);
            }
        }

        function renderModelsList(container) {
            container.innerHTML = '';
            Object.keys(modelsConfig).forEach(key => {
                const conf = modelsConfig[key];
                const isOwned = saveData.ownedModels.includes(key);
                const isEquipped = saveData.equippedModel === key;
                const isPreview = previewModel === key;

                const div = document.createElement('div');
                div.className = `p-4 border rounded cursor-pointer transition-all ${isPreview ? 'border-purple-500 bg-purple-900/20' : 'border-gray-700 bg-gray-900/50 hover:border-gray-500'}`;
                
                div.onclick = () => { previewModel = key; updateCosmetics(); };

                div.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <div class="font-bold text-sm ${isPreview ? 'text-white' : 'text-gray-400'}">${conf.name}</div>
                        ${isEquipped ? '<div class="w-2 h-2 rounded-full bg-green-400 shadow-[0_0_5px_lime]"></div>' : ''}
                    </div>
                    <div class="text-xs font-mono text-right ${isOwned ? 'text-green-400' : 'text-yellow-400'}">
                        ${isOwned ? 'OWNED' : 'ðŸ’Ž ' + conf.cost.toLocaleString()}
                    </div>
                    <button class="mt-3 w-full py-1 text-xs font-bold border border-opacity-50 hover:border-opacity-100 ${isOwned ? (isEquipped ? 'bg-green-900/50 text-green-400 border-green-400 cursor-default' : 'bg-purple-900/50 text-purple-400 border-purple-400') : (saveData.currency >= conf.cost ? 'bg-yellow-900/50 text-yellow-400 border-yellow-400' : 'opacity-50 cursor-not-allowed border-gray-600 text-gray-600')}">
                        ${isEquipped ? 'EQUIPPED' : (isOwned ? 'EQUIP' : 'PURCHASE')}
                    </button>
                `;

                const btn = div.querySelector('button');
                if(!isEquipped) {
                    btn.onclick = (e) => {
                        e.stopPropagation();
                        if(isOwned) {
                            saveData.equippedModel = key;
                            previewModel = key;
                            saveGame();
                        } else if(saveData.currency >= conf.cost) {
                            saveData.currency -= conf.cost;
                            saveData.ownedModels.push(key);
                            saveData.equippedModel = key; // Auto equip
                            previewModel = key;
                            saveGame();
                        }
                    };
                }
                container.appendChild(div);
            });
        }

        function renderColorsList(container) {
            container.innerHTML = '';
            // Hex helper
            const hex = (h) => '#' + h.toString(16).padStart(6, '0');

            Object.keys(palettesConfig).forEach(key => {
                const conf = palettesConfig[key];
                const isOwned = saveData.ownedPalettes.includes(key);
                const isEquipped = saveData.equippedPalette === key;
                const isPreview = previewPalette === key;

                const div = document.createElement('div');
                div.className = `p-4 border rounded cursor-pointer transition-all ${isPreview ? 'border-purple-500 bg-purple-900/20' : 'border-gray-700 bg-gray-900/50 hover:border-gray-500'}`;
                
                div.onclick = () => { previewPalette = key; updateCosmetics(); };

                // Handle special palette preview style
                let colorPreview = `<div class="flex gap-1">
                            <div class="w-3 h-3 rounded-full" style="background:${hex(conf.colors.core)}"></div>
                            <div class="w-3 h-3 rounded-full" style="background:${hex(conf.colors.glow)}"></div>
                        </div>`;
                
                if (conf.special === 'chroma') {
                    colorPreview = `<div class="w-7 h-3 rounded-full rainbow-anim" style="background: linear-gradient(90deg, red, yellow, lime, cyan, blue, magenta, red);"></div>`;
                }

                div.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <div class="font-bold text-sm ${isPreview ? 'text-white' : 'text-gray-400'}">${conf.name}</div>
                        ${colorPreview}
                    </div>
                    <div class="text-xs font-mono text-right ${isOwned ? 'text-green-400' : 'text-yellow-400'}">
                        ${isOwned ? 'OWNED' : 'ðŸ’Ž ' + conf.cost.toLocaleString()}
                    </div>
                    <button class="mt-3 w-full py-1 text-xs font-bold border border-opacity-50 hover:border-opacity-100 ${isOwned ? (isEquipped ? 'bg-green-900/50 text-green-400 border-green-400 cursor-default' : 'bg-purple-900/50 text-purple-400 border-purple-400') : (saveData.currency >= conf.cost ? 'bg-yellow-900/50 text-yellow-400 border-yellow-400' : 'opacity-50 cursor-not-allowed border-gray-600 text-gray-600')}">
                        ${isEquipped ? 'EQUIPPED' : (isOwned ? 'EQUIP' : 'PURCHASE')}
                    </button>
                `;

                const btn = div.querySelector('button');
                if(!isEquipped) {
                    btn.onclick = (e) => {
                        e.stopPropagation();
                        if(isOwned) {
                            saveData.equippedPalette = key;
                            previewPalette = key;
                            saveGame();
                        } else if(saveData.currency >= conf.cost) {
                            saveData.currency -= conf.cost;
                            saveData.ownedPalettes.push(key);
                            saveData.equippedPalette = key; // Auto equip
                            previewPalette = key;
                            saveGame();
                        }
                    };
                }
                container.appendChild(div);
            });
        }

        document.getElementById('tabModels').onclick = () => { cosmeticsTab = 'models'; updateCosmetics(); };
        document.getElementById('tabColors').onclick = () => { cosmeticsTab = 'colors'; updateCosmetics(); };

        document.getElementById('startBtn').onclick = startGame;
        document.getElementById('retryBtn').onclick = startGame;
        document.getElementById('shopBtn').onclick = () => { 
            updateShop(); 
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('shopMenu').classList.remove('hidden');
        };
        document.getElementById('failShopBtn').onclick = () => {
            updateShop();
            document.getElementById('gameOver').classList.add('hidden');
            document.getElementById('shopMenu').classList.remove('hidden');
        };
        document.getElementById('successShopBtn').onclick = () => {
            updateShop();
            document.getElementById('gameSuccess').classList.add('hidden');
            document.getElementById('shopMenu').classList.remove('hidden');
        };
        document.getElementById('closeShop').onclick = () => {
            document.getElementById('shopMenu').classList.add('hidden');
            document.getElementById('mainMenu').classList.remove('hidden');
        };
        
        document.getElementById('cosmeticsBtn').onclick = () => {
            updateCosmetics();
            ['mainMenu', 'gameOver', 'gameSuccess', 'shopMenu'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById('cosmeticsMenu').classList.remove('hidden');
        };

        ['failMenuBtn', 'successMenuBtn'].forEach(id => {
            document.getElementById(id).onclick = () => {
                ['gameOver', 'gameSuccess', 'shopMenu', 'cosmeticsMenu'].forEach(s => document.getElementById(s).classList.add('hidden'));
                document.getElementById('mainMenu').classList.remove('hidden');
                if(entities.player) entities.player.destroy(); 
            }
        });

        document.getElementById('closeCosmetics').onclick = () => { document.getElementById('cosmeticsMenu').classList.add('hidden'); document.getElementById('mainMenu').classList.remove('hidden'); };

        // CHANGELOG LOGIC
        const changelogBtn = document.getElementById('changelogBtn');
        const changelogModal = document.getElementById('changelogModal');
        const closeChangelog = document.getElementById('closeChangelog');
        const changelogContent = document.getElementById('changelogContent');

        changelogBtn.onclick = () => {
            fetch('changelog.txt')
                .then(response => {
                    if (!response.ok) throw new Error('File not found');
                    return response.text();
                })
                .then(text => {
                    changelogContent.textContent = text;
                    changelogModal.classList.remove('hidden');
                })
                .catch(err => {
                    changelogContent.textContent = "ERROR: UNABLE TO ACCESS SYSTEM LOGS.\n\nNote: If you are running this file locally, the Fetch API may be blocked by your browser for security reasons (CORS). Please run via a local server (e.g. VS Code Live Server) or ensure 'changelog.txt' exists.";
                    changelogModal.classList.remove('hidden');
                });
        };

        closeChangelog.onclick = () => {
            changelogModal.classList.add('hidden');
        };
        
        // Initial setup
        updateArenaGeometry();

    </script>
</body>
</html>